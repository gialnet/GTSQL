CREATE OR REPLACE PROCEDURE ACTUALIZACLAVEIBI AS
	xREFERENCIA CHAR(20);
	xDESCRIPCION VARCHAR2(100);
	xMAXID INTEGER;
	-- cursor para borrar registros duplicados (misma referencia y nif)
	CURSOR C2 IS SELECT NIF,CLAVE_TRIBUTO,COUNT(*) FROM TRIBUTOSCONTRI
				 WHERE PROGRAMA='IBI'
				 GROUP BY NIF,CLAVE_TRIBUTO
				 HAVING COUNT(*)>1;
	CURSOR C1 IS SELECT * FROM TRIBUTOSCONTRI
	             WHERE PROGRAMA='IBI'
			     FOR UPDATE OF CLAVE_TRIBUTO,DESCRIPCION;
BEGIN

   FOR v2 IN C2
   LOOP
      SELECT MAX(ID_CONCEPTO) INTO xMAXID FROM TRIBUTOSCONTRI
      WHERE PROGRAMA='IBI' AND NIF=v2.NIF AND CLAVE_TRIBUTO=v2.CLAVE_TRIBUTO;
      DELETE FROM TRIBUTOSCONTRI WHERE PROGRAMA='IBI' AND NIF=v2.NIF AND
      CLAVE_TRIBUTO=v2.CLAVE_TRIBUTO AND ID_CONCEPTO<>xMAXID;
   END LOOP;


   FOR v1 IN C1
   LOOP
	  xREFERENCIA:=NULL;
	  begin
	     SELECT REF_CATASTRAL||NUMERO_SECUENCIAL||PRIMER_CARACTER_CONTROL||
		        SEGUN_CARACTER_CONTROL,
		        SUBSTR('Ref.Cat: '||REF_CATASTRAL||NUMERO_SECUENCIAL||
		        PRIMER_CARACTER_CONTROL||SEGUN_CARACTER_CONTROL||'-V.Cat: '||
		        VALOR_CATASTRAL||'-D.Trib: '||RTRIM(TIPO_VIA)||' '||
		        RTRIM(NOMBRE_VIA)||' '||PRIMER_NUMERO||' '||PRIMERA_LETRA||' '||
		        ESCALERA||' '||PLANTA||' '||PUERTA,1,100) INTO xREFERENCIA,xDESCRIPCION
	     FROM IBI WHERE ID=v1.ID_CONCEPTO;
	     Exception
	        When no_data_found then
		       xREFERENCIA:=v1.CLAVE_TRIBUTO;
		       xDESCRIPCION:=v1.DESCRIPCION;
	  end;

	  UPDATE TRIBUTOSCONTRI SET CLAVE_TRIBUTO=xREFERENCIA,DESCRIPCION=xDESCRIPCION
	  WHERE CURRENT OF C1;
   END LOOP;
END;
/

EXECUTE ACTUALIZACLAVEIBI;
DROP PROCEDURE ACTUALIZACLAVEIBI;


/********************************************************************************/

CREATE OR REPLACE PROCEDURE ACTUALIZACLAVERUS AS
	xDESCRIPCION VARCHAR2(100);
	xMAXID INTEGER;
	-- cursor para borrar registros duplicados (misma clave_tributo y nif)
	CURSOR C2 IS SELECT NIF,CLAVE_TRIBUTO,COUNT(*)
			 FROM TRIBUTOSCONTRI
			 WHERE PROGRAMA='RUSTICA'
			 GROUP BY NIF,CLAVE_TRIBUTO
			 HAVING COUNT(*)>1;
	CURSOR C1 IS SELECT * FROM TRIBUTOSCONTRI
	             WHERE PROGRAMA='RUSTICA'
      		 FOR UPDATE OF DESCRIPCION;
BEGIN

   FOR v2 IN C2
   LOOP
      SELECT MAX(ID_CONCEPTO) INTO xMAXID FROM TRIBUTOSCONTRI
      WHERE PROGRAMA='RUSTICA' AND NIF=v2.NIF AND CLAVE_TRIBUTO=v2.CLAVE_TRIBUTO;
      DELETE FROM TRIBUTOSCONTRI WHERE PROGRAMA='RUSTICA' AND NIF=v2.NIF AND
      CLAVE_TRIBUTO=v2.CLAVE_TRIBUTO AND ID_CONCEPTO<>xMAXID;
   END LOOP;


   FOR v1 IN C1
   LOOP
	  xDESCRIPCION:=NULL;
	  begin
	     SELECT 'Nº Fijo: '||NUM_FIJO||'-'||'V.Cat: '||VALOR_CATASTRAL||'-'||
		      TO_CHAR(SUPERFICIE_TOTAL,'000D99')||' H.' INTO xDESCRIPCION
	     FROM RUS80 WHERE ID=v1.ID_CONCEPTO;
	     Exception
	        When no_data_found then		      
		       xDESCRIPCION:=v1.DESCRIPCION;
	  end;

	  UPDATE TRIBUTOSCONTRI SET DESCRIPCION=xDESCRIPCION
	  WHERE CURRENT OF C1;
   END LOOP;
END;
/

EXECUTE ACTUALIZACLAVERUS;
DROP PROCEDURE ACTUALIZACLAVERUS;

/********************************************************************************/

CREATE OR REPLACE PROCEDURE ACTUALIZACLAVEIAE AS
	xDESCRIPCION VARCHAR2(100);
      xEPIGRAFE VARCHAR2(60);
      xREFERENCIA CHAR(13);
      xIDEPI INTEGER;
	xMAXID INTEGER;
	-- cursor para borrar registros duplicados (misma clave_tributo y nif)
	CURSOR C2 IS SELECT NIF,CLAVE_TRIBUTO,COUNT(*)
			 FROM TRIBUTOSCONTRI
			 WHERE PROGRAMA='IAE'
			 GROUP BY NIF,CLAVE_TRIBUTO
			 HAVING COUNT(*)>1;
	CURSOR C1 IS SELECT * FROM TRIBUTOSCONTRI
	             WHERE PROGRAMA='IAE'
			 FOR UPDATE OF DESCRIPCION;
BEGIN

   FOR v2 IN C2
   LOOP
      SELECT MAX(ID_CONCEPTO) INTO xMAXID FROM TRIBUTOSCONTRI
      WHERE PROGRAMA='IAE' AND NIF=v2.NIF AND CLAVE_TRIBUTO=v2.CLAVE_TRIBUTO;
      DELETE FROM TRIBUTOSCONTRI WHERE PROGRAMA='IAE' AND NIF=v2.NIF AND
      CLAVE_TRIBUTO=v2.CLAVE_TRIBUTO AND ID_CONCEPTO<>xMAXID;
   END LOOP;


   FOR v1 IN C1
   LOOP
      xDESCRIPCION:=NULL;

      SELECT ID_EPIGRAFE,REFERENCIA INTO xIDEPI,xREFERENCIA
	FROM IAE WHERE ID=v1.ID_CONCEPTO;

	begin
         SELECT EPIGRAFE||' '||SECCION||' '||TIPO_ACTIVIDAD||' '||NOMBRE
	   INTO xEPIGRAFE FROM EPIGRAFE WHERE ID=xIDEPI;
	   xDESCRIPCION:=SUBSTR('Referencia: '||xREFERENCIA||'-Epígrafe: '||xEPIGRAFE,1,100);
	Exception
	   When no_data_found then
		xDESCRIPCION:='Referencia: '||xREFERENCIA;
	end;

	UPDATE TRIBUTOSCONTRI SET DESCRIPCION=xDESCRIPCION
	WHERE CURRENT OF C1;
   END LOOP;
END;
/

EXECUTE ACTUALIZACLAVEIAE;
DROP PROCEDURE ACTUALIZACLAVEIAE;

/********************************************************************************/