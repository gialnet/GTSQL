/*******************************************************************************************
Modificación: 24/02/2003 Mª del Carmen Junco Gómez. El parámetro xNIF_INTERIOR se cambia
por xNIF_ANTERIOR.
********************************************************************************************/
CREATE OR REPLACE PROCEDURE INSERTA_VARPAD(
	xMUNICIPIO				CHAR,
	xTIPO_REGISTRO			CHAR,
	xCOD_DELEGACION_MEH		CHAR,
	xCOD_GERENCIA			CHAR,
	xCOD_MUNICIPIO_MEH		CHAR,
	xREF_CATASTRAL			CHAR,
      xNUM_SECUENCIAL			CHAR,
	xPRIMER_CC				CHAR,
	xSEGUNDO_CC				CHAR,
	xNUM_FIJO				CHAR,
	xLETRA_NUM_FIJO			CHAR,
	xIDENTIFICACION			CHAR,
	xCOEF_PARTICIPACION		CHAR,
	xCOD_PROVINCIA_INE		CHAR,
	xCOD_MUNICIPIO_INE		CHAR,
	xDISTRITO_MUNI			CHAR,

	/* Domicilio Tributario */
	xCOD_ENTIDAD_MENOR		CHAR,
	xCOD_VIA_PUBLICA			CHAR,
	xTIPO_VIA				CHAR,
	xNOMBRE_VIA				CHAR,
	xPRIMER_NUM_VIA			CHAR,
	xPRIMERA_LETRA			CHAR,	
	xSEGUNDO_NUM_VIA			CHAR,
	xSEGUNDA_LETRA			CHAR,
	xKILOMETRO				CHAR,
	xBLOQUE				CHAR,
	xTEXTO_DIRECCION			CHAR,
	xCP					CHAR,
	xESCALERA				CHAR,
	xPLANTA				CHAR,
	xPUERTA				CHAR,

	/* Identificacion del titular */

	xNIF					CHAR,
	xPERSONALIDAD			CHAR,
	xNOMBRE				CHAR,
	xNUM_COMPONENTES			CHAR,
	xCOMPLEMENTO_NOMBRE		CHAR,
	xCOD_MEH_TIT			CHAR,
	xCOD_MUNICIPIO_DGC_TIT		CHAR,
	xCOD_PROVINCIA_INE_TIT		CHAR,
	xCOD_MUNICIPIO_INE_TIT		CHAR,
	xCOD_VIA_PUBLICA_TIT		CHAR,
	xTIPO_VIA_TIT			CHAR,
	xNOMBRE_VIA_TIT			CHAR,
	xPRIMER_NUM_VIA_TIT		CHAR,
	xPRIMERA_LETRA_TIT		CHAR,
	xSEGUNDO_NUM_VIA_TIT		CHAR,
	xSEGUNDA_LETRA_TIT		CHAR,
	xKILOMETRO_TIT			CHAR,
	xBLOQUE_TIT				CHAR,
	xTEXTO_DIRECCION_TIT		CHAR,
	xESCALERA_TIT			CHAR,
	xPLANTA_TIT				CHAR,
	xPUERTA_TIT				CHAR,
	xCP_TIT				CHAR,
	xAP_CORREOS_TIT			CHAR,
	xPAIS_TIT				CHAR,
	xPROVINCIA_TIT			CHAR,
	xMUNICIPIO_TIT			CHAR,

	/* Datos economicos del bien inmueble */

	xYEAR_VALOR_CATASTRAL		CHAR,
	xVALOR_CATASTRAL			CHAR,
	xVALOR_CATASTRAL_SUELO		CHAR,
	xVALOR_CATASTRAL_CONTRUCCION	CHAR,
	xBASE_LIQUIDABLE			CHAR,
	xCLAVE_USO				CHAR,
	xYEAR_ULTIMA_REVISION		CHAR,
	xYEAR_ULTIMA_NOTIFICACION	CHAR,
	xNUM_ULTIMA_NOTIFICACION	CHAR,
	xSUPERFICIE_CONTRUCTIVO		CHAR,
	xSUPERFICIE_SUELO			CHAR,
	xCOEF_PROPIEDAD			CHAR,
	
	/* Datos de movimiento */

	xTIPO_MOVIMIENTO			CHAR,
	xYEAR_EXPEDIENTE			CHAR,
	xREF_EXPEDIENTE			CHAR,
	xCOD_ENTIDAD_COLA			CHAR,
	xEXISTENCIA_ALTERA		CHAR,
	xCOD_MOVIMIENTO			CHAR,
	xFECHA_MOVIMIENTO			CHAR,
	xHORA_MOVIMIENTO			CHAR,
	xFECHA_ALTERACION			CHAR,
	xEJER_ENTRADA			CHAR,
	xCLAVE_CATASTRAL			CHAR,
	xNIF_ANTERIOR			CHAR,
	

	/* Datos de la tasa de inscripcion catastral */
	
	xNUM_JUSTIFICANTE			CHAR,
	xIMPORTE_INGRESO			CHAR,
	xFECHA_INGRESO			CHAR,
	xCOD_ENTIDAD_BANCARIA		CHAR,
	xCOD_SUCURSAL			CHAR,
	xNIF_INGRESO			CHAR,
	xNOMBRE_INGRESO			CHAR,

	/* Quien realiza la inserción: - al leer el fichero enviado por la Gerencia.(G)
						 - al modificar un registro desde el Ayuntamiento.(A)*/
	xQUIEN				CHAR
)
AS

BEGIN


INSERT INTO VARPAD(
	MUNICIPIO,
	TIPO_REGISTRO,
	COD_DELEGACION_MEH,
	COD_GERENCIA,
	COD_MUNICIPIO,
	REF_CATASTRAL,
	NUMERO_SECUENCIAL,
	PRIMER_CARACTER_CONTROL,
	SEGUN_CARACTER_CONTROL,
	NUM_FIJO,
	LETRA_NUM_FIJO,
	IDENTIFICACION,
	COEFICIENTE_PARTICI,
	COD_PROVI_INE,
	COD_MUNI_INE,
	DISTRITO_MUNI,

	/* Domicilio Tributario */
	COD_ENTIDAD_MENOR,
	COD_VIA_PUBLICA,
	TIPO_VIA,
	NOMBRE_VIA,
	PRIMER_NUMERO,
	PRIMERA_LETRA,
	SEGUNDO_NUMERO,
	SEGUNDA_LETRA,
	KILOMETRO,
	BLOQUE,
	TEXTO_DIRECCION,
	CODIGO_POSTAL,
	ESCALERA,
	PLANTA,
	PUERTA,

	/* Identificacion del titular */

	NIF,
	PERSONALIDAD,
	NOMBRE,
	NUM_COMPONENTES,
	COMPLEMENTO_NOMBRE,
	COD_DEL_MEH,
	COD_MUNICIPIO_DGC,
	COD_PROVI_INE_FISCAL,
	COD_MUNI_INE_FISCAL,
	COD_VIA_PUBLICA_FISCAL,
	TIPO_VIA_FISCAL,
	NOMBRE_VIA_FISCAL,
	PRIMER_NUMERO_FISCAL,
	PRIMERA_LETRA_FISCAL,
	SEGUNDO_NUMERO_FISCAL,
	SEGUNDA_LETRA_FISCAL,
	KILOMETRO_FISCAL,
	BLOQUE_FISCAL,
	TEXTO_DIRECCION_FISCAL,
	ESCALERA_FISCAL,
	PLANTA_FISCAL,
	PUERTA_FISCAL,
	COD_POSTAL_FISCAL,
	APARTADO_CORREOS,
	PAIS,
	PROVINCIA,
	MUNICIPIO_FISCAL,

	/* Datos economicos del bien inmueble */

	YEAR_VALOR_CATASTRAL,
	VALOR_CATASTRAL,
	VALOR_SUELO,
	VALOR_CONSTRUCCION,
	BASE_LIQUIDABLE,
	CLAVE_USO,
	YEAR_ULTIMA_REVISION,
	YEAR_ULTIMA_NOTIFICACION,
	NUM_ULTIMA_NOTIFICACION,
	SUPERFICIE_FINCAS,
	SUPERFICIE_SOLARES,
	COEFICIENTE_FINCA,
	
	/* Datos de movimiento */

	TIPO_MOVIMIENTO,
	YEAR_EXPEDIENTE,
	REF_EXPEDIENTE,
	COD_ENTIDAD_COLA,	EXISTENCIA_ALTERA,
	COD_MOVIMIENTO,
	FECHA_MOVIMIENTO,
	HORA_MOVIMIENTO,
	FECHA_ALTERACION,
	EJER_ENTRADA,
	CLAVE_CATASTRAL,
	NIF_INTERIOR,
	

	/* Datos de la tasa de inscripcion catastral */
	
	NUM_JUSTIFICANTE,
	IMPORTE_INGRESO,
	FECHA_INGRESO,
	COD_ENTIDAD_BANCARIA,
	COD_SUCURSAL,
	NIF_INGRESO,
	NOMBRE_INGRESO,
	QUIEN_MODIFICA)

  VALUES
	(xMUNICIPIO,

	xTIPO_REGISTRO,
	xCOD_DELEGACION_MEH,
	xCOD_GERENCIA,
	xCOD_MUNICIPIO_MEH,
	xREF_CATASTRAL,
	xNUM_SECUENCIAL,
	xPRIMER_CC,
	xSEGUNDO_CC,
	xNUM_FIJO,
	xLETRA_NUM_FIJO,
	xIDENTIFICACION,
	xCOEF_PARTICIPACION,
	xCOD_PROVINCIA_INE,
	xCOD_MUNICIPIO_INE,
	xDISTRITO_MUNI,

	/* Domicilio Tributario */
	xCOD_ENTIDAD_MENOR,
	xCOD_VIA_PUBLICA,
	xTIPO_VIA,
	xNOMBRE_VIA,
	xPRIMER_NUM_VIA,
	xPRIMERA_LETRA,
	xSEGUNDO_NUM_VIA,
	xSEGUNDA_LETRA,
	xKILOMETRO,
	xBLOQUE,
	xTEXTO_DIRECCION,
	xCP,
	xESCALERA,
	xPLANTA,
	xPUERTA,

	/* Identificacion del titular */

	xNIF,
	xPERSONALIDAD,
	xNOMBRE,
	xNUM_COMPONENTES,
	xCOMPLEMENTO_NOMBRE,

	/* Domicilio titular */
	xCOD_MEH_TIT,
	xCOD_MUNICIPIO_DGC_TIT,
	xCOD_PROVINCIA_INE_TIT,
	xCOD_MUNICIPIO_INE_TIT,
	xCOD_VIA_PUBLICA_TIT,
	xTIPO_VIA_TIT,
	xNOMBRE_VIA_TIT,
	xPRIMER_NUM_VIA_TIT,
	xPRIMERA_LETRA_TIT,
	xSEGUNDO_NUM_VIA_TIT,
	xSEGUNDA_LETRA_TIT,
	xKILOMETRO_TIT,
	xBLOQUE_TIT,
	xTEXTO_DIRECCION_TIT,
	xESCALERA_TIT,
	xPLANTA_TIT,
	xPUERTA_TIT,
	xCP_TIT,
	xAP_CORREOS_TIT,
	xPAIS_TIT,
	xPROVINCIA_TIT,
	xMUNICIPIO_TIT,

	/* Datos economicos del bien inmueble */

	xYEAR_VALOR_CATASTRAL,
	xVALOR_CATASTRAL,
	xVALOR_CATASTRAL_SUELO,
	xVALOR_CATASTRAL_CONTRUCCION,
	xBASE_LIQUIDABLE,
	xCLAVE_USO,
	xYEAR_ULTIMA_REVISION,
	xYEAR_ULTIMA_NOTIFICACION,
	xNUM_ULTIMA_NOTIFICACION,
	xSUPERFICIE_CONTRUCTIVO,
	xSUPERFICIE_SUELO,
	xCOEF_PROPIEDAD,
	
	/* Datos de movimiento */

	xTIPO_MOVIMIENTO,
	xYEAR_EXPEDIENTE,
	xREF_EXPEDIENTE,
	xCOD_ENTIDAD_COLA,
	xEXISTENCIA_ALTERA,
	xCOD_MOVIMIENTO,
	xFECHA_MOVIMIENTO,
	xHORA_MOVIMIENTO,
	xFECHA_ALTERACION,
	xEJER_ENTRADA,
	xCLAVE_CATASTRAL,
	xNIF_ANTERIOR,
	
	/* Datos de la tasa de inscripcion catastral */
	
	xNUM_JUSTIFICANTE,
	xIMPORTE_INGRESO,
	xFECHA_INGRESO,
	xCOD_ENTIDAD_BANCARIA,
	xCOD_SUCURSAL,
	xNIF_INGRESO,
	xNOMBRE_INGRESO,
	xQUIEN);

END;
/

/***********************************************************************/

CREATE OR REPLACE PROCEDURE ALTA_VARPAD(
	xMUNICIPIO	IN 	CHAR)
AS
	xFECHA_MOVIMIENTO DATE DEFAULT NULL;
	xFECHA_ALTERACION DATE DEFAULT NULL;
	xFECHA_INGRESO	DATE DEFAULT NULL;
	xID			INTEGER;

      CURSOR CVARPAD IS SELECT * FROM VARPAD WHERE MUNICIPIO=xMUNICIPIO
							   AND TIPO_MOVIMIENTO='A'
				ORDER BY FECHA_MOVIMIENTO,HORA_MOVIMIENTO;

BEGIN

   FOR v_varpad IN CVARPAD 
   LOOP

	/* primero insertamos un registro en la tabla de fincas */

	if (v_varpad.FECHA_MOVIMIENTO<>'00000000') then
	   xFECHA_MOVIMIENTO:=TO_DATE(v_varpad.FECHA_MOVIMIENTO,'yyyy/mm/dd');
	END IF;

	if (v_varpad.FECHA_ALTERACION<>'00000000') then
	   xFECHA_ALTERACION:=TO_DATE(v_varpad.FECHA_ALTERACION,'yyyy/mm/dd');
	END IF;

	if (v_varpad.FECHA_INGRESO<>'00000000') then
	   xFECHA_INGRESO:=TO_DATE(v_varpad.FECHA_INGRESO,'yyyy/mm/dd');
	END IF;


	INSERT INTO IBI_FINCA_FURB 
		(MUNICIPIO,REF_CATASTRAL,DISTRITO_CENSAL,COD_ENTIDAD_MENOR,COD_VIA_PUBLICA,TIPO_VIA,
	 	NOMBRE_VIA,PRIMER_NUMERO,PRIMERA_LETRA,SEGUNDO_NUMERO,SEGUNDA_LETRA,KILOMETRO,
		BLOQUE,TEXTO_DIRECCION,CODIGO_POSTAL,TIPO_MOVIMIENTO,YEAR_EXPEDIENTE,
		REF_EXPEDIENTE,COD_ENTIDAD_ORIGEN_EXPE,EXISTE_DECLARA_ALTERACION,
		COD_MOTIVO_MOVIMIENTO,FECHA_MOVIMIENTO,HORA_MOVIMIENTO,FECHA_ALTERA_CATASTRAL,	
		NUM_IMPRESO_AUTOLIQUI,IMPORTE_INGRESADO,FECHA_INGRESO,COD_ENTIDAD,COD_SUCURSAL,
		NIF_TITULAR_INGRESO,NOMBRE_TITULAR_INGRESO)
	VALUES
		(xMUNICIPIO,v_varpad.REF_CATASTRAL,v_varpad.DISTRITO_MUNI,v_varpad.COD_ENTIDAD_MENOR,
		v_varpad.COD_VIA_PUBLICA,v_varpad.TIPO_VIA,v_varpad.NOMBRE_VIA,
		v_varpad.PRIMER_NUMERO,v_varpad.PRIMERA_LETRA,v_varpad.SEGUNDO_NUMERO,
		v_varpad.SEGUNDA_LETRA,v_varpad.KILOMETRO,v_varpad.BLOQUE,
		v_varpad.TEXTO_DIRECCION,v_varpad.CODIGO_POSTAL,v_varpad.TIPO_MOVIMIENTO,
		v_varpad.YEAR_EXPEDIENTE,v_varpad.REF_EXPEDIENTE,v_varpad.COD_ENTIDAD_COLA,
		v_varpad.EXISTENCIA_ALTERA,v_varpad.COD_MOVIMIENTO,xFECHA_MOVIMIENTO,
		v_varpad.HORA_MOVIMIENTO,xFECHA_ALTERACION,v_varpad.NUM_JUSTIFICANTE,
		TO_NUMBER(v_varpad.IMPORTE_INGRESO),xFECHA_INGRESO,v_varpad.COD_ENTIDAD_BANCARIA,
		v_varpad.COD_SUCURSAL,v_varpad.NIF_INGRESO,v_varpad.NOMBRE_INGRESO)
	RETURN ID INTO xID;

	/* ahora insertamos el correspondiente registro en la tabla de cargos*/

	INSERT INTO IBI_CARGO_FURB
		(MUNICIPIO,COD_DELEGACION_MEH,COD_GERENCIA,COD_MUNICIPIO,ID_FINCA,REF_CATASTRAL,
		NUM_CARGO,PRIMER_CARACTER_CONTROL,SEGUN_CARACTER_CONTROL,NUM_FIJO,
		CARACTER_CONTROL_N_FIJO,COEF_PARTICIPACION,IDENTIFICACION,COD_PROVINCIA_INE,
		COD_MUNICIPIO_INE,DISTRITO_CENSAL,COD_ENTIDAD_MENOR,COD_VIA_PUBLICA,TIPO_VIA,
		NOMBRE_VIA,PRIMER_NUMERO,PRIMERA_LETRA,SEGUNDO_NUMERO,SEGUNDA_LETRA,KILOMETRO,
		BLOQUE,TEXTO_DIRECCION,CODIGO_POSTAL,ESCALERA,PLANTA,PUERTA,NIF,PERSONALIDAD,
		NOMBRE,NUM_COMPONENTES,COMPLEMENTO_NOMBRE,COD_DEL_MEH,COD_MUNICIPIO_DGC,
		COD_PROVI_INE_FISCAL,COD_MUNI_INE_FISCAL,COD_VIA_PUBLICA_FISCAL,TIPO_VIA_FISCAL,
		NOMBRE_VIA_FISCAL,PRIMER_NUMERO_FISCAL,PRIMERA_LETRA_FISCAL,SEGUNDO_NUMERO_FISCAL,
		SEGUNDA_LETRA_FISCAL,KILOMETRO_FISCAL,BLOQUE_FISCAL,TEXTO_DIRECCION_FISCAL,
		ESCALERA_FISCAL,PLANTA_FISCAL,PUERTA_FISCAL,COD_POSTAL_FISCAL,APARTADO_CORREOS,
		PAIS,PROVINCIA,MUNICIPIO_FISCAL,YEAR_VALOR_CATASTRAL,VALOR_CATASTRAL,VALOR_SUELO,
		VALOR_CONSTRUCCION,BASE_LIQUIDABLE,CLAVE_USO,YEAR_ULTIMA_REVISION,
		YEAR_ULTIMA_NOTIFICACION,NUM_ULTIMA_NOTI,SUPERF_ELEM_CONSTRUCTIVOS,
		SUPERFICIE_ELEM_SUELO,COEFICIENTE_FINCA,TIPO_MOVIMIENTO,YEAR_EXPEDIENTE,
		REF_EXPEDIENTE,EJERCICIO_ENTRADA_PADRON,CLAVE_CATASTRAL_ANTERIOR,NIF_ANTERIOR)

	VALUES
		(xMUNICIPIO,v_varpad.COD_DELEGACION_MEH,v_varpad.COD_GERENCIA,
		v_varpad.COD_MUNICIPIO,xID,v_varpad.REF_CATASTRAL,v_varpad.NUMERO_SECUENCIAL,
		v_varpad.PRIMER_CARACTER_CONTROL,v_varpad.SEGUN_CARACTER_CONTROL,
		v_varpad.NUM_FIJO,v_varpad.LETRA_NUM_FIJO,v_varpad.COEFICIENTE_PARTICI,
		v_varpad.IDENTIFICACION,v_varpad.COD_PROVI_INE,v_varpad.COD_MUNI_INE,
		v_varpad.DISTRITO_MUNI,v_varpad.COD_ENTIDAD_MENOR,v_varpad.COD_VIA_PUBLICA,
		v_varpad.TIPO_VIA,v_varpad.NOMBRE_VIA,v_varpad.PRIMER_NUMERO,
		v_varpad.PRIMERA_LETRA,v_varpad.SEGUNDO_NUMERO,v_varpad.SEGUNDA_LETRA,
		v_varpad.KILOMETRO,v_varpad.BLOQUE,v_varpad.TEXTO_DIRECCION,v_varpad.CODIGO_POSTAL,
		v_varpad.ESCALERA,v_varpad.PLANTA,v_varpad.PUERTA,v_varpad.NIF,
		v_varpad.PERSONALIDAD,v_varpad.NOMBRE,v_varpad.NUM_COMPONENTES,
		v_varpad.COMPLEMENTO_NOMBRE,v_varpad.COD_DEL_MEH,v_varpad.COD_MUNICIPIO_DGC,
		v_varpad.COD_PROVI_INE_FISCAL,v_varpad.COD_MUNI_INE_FISCAL,
		v_varpad.COD_VIA_PUBLICA_FISCAL,v_varpad.TIPO_VIA_FISCAL,v_varpad.NOMBRE_VIA_FISCAL,
		v_varpad.PRIMER_NUMERO_FISCAL,v_varpad.PRIMERA_LETRA_FISCAL,
		v_varpad.SEGUNDO_NUMERO_FISCAL,v_varpad.SEGUNDA_LETRA_FISCAL,
		v_varpad.KILOMETRO_FISCAL,v_varpad.BLOQUE_FISCAL,v_varpad.TEXTO_DIRECCION_FISCAL,
		v_varpad.ESCALERA_FISCAL,v_varpad.PLANTA_FISCAL,v_varpad.PUERTA_FISCAL,
		v_varpad.COD_POSTAL_FISCAL,v_varpad.APARTADO_CORREOS,v_varpad.PAIS,
		v_varpad.PROVINCIA,v_varpad.MUNICIPIO_FISCAL,v_varpad.YEAR_VALOR_CATASTRAL,
		TO_NUMBER(v_varpad.VALOR_CATASTRAL),TO_NUMBER(v_varpad.VALOR_SUELO),
		TO_NUMBER(v_varpad.VALOR_CONSTRUCCION),TO_NUMBER(v_varpad.BASE_LIQUIDABLE),
		v_varpad.CLAVE_USO,v_varpad.YEAR_ULTIMA_REVISION,v_varpad.YEAR_ULTIMA_NOTIFICACION,
		v_varpad.NUM_ULTIMA_NOTIFICACION,TO_NUMBER(v_varpad.SUPERFICIE_FINCAS),
		TO_NUMBER(v_varpad.SUPERFICIE_SOLARES),v_varpad.COEFICIENTE_FINCA,
		v_varpad.TIPO_MOVIMIENTO,v_varpad.YEAR_EXPEDIENTE,v_varpad.REF_EXPEDIENTE,
		v_varpad.EJER_ENTRADA,v_varpad.CLAVE_CATASTRAL,v_varpad.NIF_INTERIOR);

   END LOOP;

END;
/

/*********************************************************************************************/

CREATE OR REPLACE PROCEDURE MODIFICACION_VARPAD(
	xMUNICIPIO	IN 	CHAR)
AS
	xFECHA_MOVIMIENTO DATE DEFAULT NULL;
	xFECHA_ALTERACION DATE DEFAULT NULL;
	xFECHA_INGRESO	DATE DEFAULT NULL;
	xID			INTEGER;

      CURSOR CVARPAD IS SELECT * FROM VARPAD WHERE MUNICIPIO=xMUNICIPIO
							   AND TIPO_MOVIMIENTO='M'
				ORDER BY FECHA_MOVIMIENTO,HORA_MOVIMIENTO;


BEGIN

   FOR v_varpad IN CVARPAD 
   LOOP

      /* primero modificamos el registro en la tabla de fincas */

	if (v_varpad.FECHA_MOVIMIENTO<>'00000000') then
	   xFECHA_MOVIMIENTO:=TO_DATE(v_varpad.FECHA_MOVIMIENTO,'yyyy/mm/dd');
	END IF;

	if (v_varpad.FECHA_ALTERACION<>'00000000') then
	   xFECHA_ALTERACION:=TO_DATE(v_varpad.FECHA_ALTERACION,'yyyy/mm/dd');
	END IF;

	if (v_varpad.FECHA_INGRESO<>'00000000') then
	   xFECHA_INGRESO:=TO_DATE(v_varpad.FECHA_INGRESO,'yyyy/mm/dd');
	END IF;

	UPDATE IBI_FINCA_FURB SET
					COD_ENTIDAD_MENOR=v_varpad.COD_ENTIDAD_MENOR,
					COD_VIA_PUBLICA=v_varpad.COD_VIA_PUBLICA,
					TIPO_VIA=v_varpad.TIPO_VIA,
	 				NOMBRE_VIA=v_varpad.NOMBRE_VIA,
					PRIMER_NUMERO=v_varpad.PRIMER_NUMERO,
					PRIMERA_LETRA=v_varpad.PRIMERA_LETRA,
					SEGUNDO_NUMERO=v_varpad.SEGUNDO_NUMERO,
					SEGUNDA_LETRA=v_varpad.SEGUNDA_LETRA,
					KILOMETRO=v_varpad.KILOMETRO,
					BLOQUE=v_varpad.BLOQUE,
					TEXTO_DIRECCION=v_varpad.TEXTO_DIRECCION,
					CODIGO_POSTAL=v_varpad.CODIGO_POSTAL,
					TIPO_MOVIMIENTO=v_varpad.TIPO_MOVIMIENTO,
					YEAR_EXPEDIENTE=v_varpad.YEAR_EXPEDIENTE,
					REF_EXPEDIENTE=v_varpad.REF_EXPEDIENTE,
					COD_ENTIDAD_ORIGEN_EXPE=v_varpad.COD_ENTIDAD_COLA,
					EXISTE_DECLARA_ALTERACION=v_varpad.EXISTENCIA_ALTERA,
					COD_MOTIVO_MOVIMIENTO=v_varpad.COD_MOVIMIENTO,
					FECHA_MOVIMIENTO=xFECHA_MOVIMIENTO,
					HORA_MOVIMIENTO=v_varpad.HORA_MOVIMIENTO,
					FECHA_ALTERA_CATASTRAL=xFECHA_ALTERACION,	
					NUM_IMPRESO_AUTOLIQUI=v_varpad.NUM_JUSTIFICANTE,
					IMPORTE_INGRESADO=TO_NUMBER(v_varpad.IMPORTE_INGRESO),
					FECHA_INGRESO=xFECHA_INGRESO,
					COD_ENTIDAD=v_varpad.COD_ENTIDAD_BANCARIA,
					COD_SUCURSAL=v_varpad.COD_SUCURSAL,
					NIF_TITULAR_INGRESO=v_varpad.NIF_INGRESO,
					NOMBRE_TITULAR_INGRESO=v_varpad.NOMBRE_INGRESO
	WHERE MUNICIPIO=xMUNICIPIO AND REF_CATASTRAL=v_varpad.REF_CATASTRAL;


	/* ahora modificamos el registro en la tabla de cargos*/

	UPDATE IBI_CARGO_FURB SET 
					COD_ENTIDAD_MENOR=v_varpad.COD_ENTIDAD_MENOR,
					COD_VIA_PUBLICA=v_varpad.COD_VIA_PUBLICA,
					TIPO_VIA=v_varpad.TIPO_VIA,
					NOMBRE_VIA=v_varpad.NOMBRE_VIA,
					PRIMER_NUMERO=v_varpad.PRIMER_NUMERO,
					PRIMERA_LETRA=v_varpad.PRIMERA_LETRA,
					SEGUNDO_NUMERO=v_varpad.SEGUNDO_NUMERO,
					SEGUNDA_LETRA=v_varpad.SEGUNDA_LETRA,
					KILOMETRO=v_varpad.KILOMETRO,
					BLOQUE=v_varpad.BLOQUE,
					TEXTO_DIRECCION=v_varpad.TEXTO_DIRECCION,
					CODIGO_POSTAL=v_varpad.CODIGO_POSTAL,
					ESCALERA=v_varpad.ESCALERA,
					PLANTA=v_varpad.PLANTA,
					PUERTA=v_varpad.PUERTA,
					NIF=v_varpad.NIF,
					PERSONALIDAD=v_varpad.PERSONALIDAD,
					NOMBRE=v_varpad.NOMBRE,
					NUM_COMPONENTES=v_varpad.NUM_COMPONENTES,
					COMPLEMENTO_NOMBRE=v_varpad.COMPLEMENTO_NOMBRE,
					COD_DEL_MEH=v_varpad.COD_DEL_MEH,
					COD_MUNICIPIO_DGC=v_varpad.COD_MUNICIPIO_DGC,
					COD_PROVI_INE_FISCAL=v_varpad.COD_PROVI_INE_FISCAL,
					COD_MUNI_INE_FISCAL=v_varpad.COD_MUNI_INE_FISCAL,
					COD_VIA_PUBLICA_FISCAL=v_varpad.COD_VIA_PUBLICA_FISCAL,
					TIPO_VIA_FISCAL=v_varpad.TIPO_VIA_FISCAL,
					NOMBRE_VIA_FISCAL=v_varpad.NOMBRE_VIA_FISCAL,
					PRIMER_NUMERO_FISCAL=v_varpad.PRIMER_NUMERO_FISCAL,
					PRIMERA_LETRA_FISCAL=v_varpad.PRIMERA_LETRA_FISCAL,
					SEGUNDO_NUMERO_FISCAL=v_varpad.SEGUNDO_NUMERO_FISCAL,
					SEGUNDA_LETRA_FISCAL=v_varpad.SEGUNDA_LETRA_FISCAL,
					KILOMETRO_FISCAL=v_varpad.KILOMETRO_FISCAL,
					BLOQUE_FISCAL=v_varpad.BLOQUE_FISCAL,
					TEXTO_DIRECCION_FISCAL=v_varpad.TEXTO_DIRECCION_FISCAL,
					ESCALERA_FISCAL=v_varpad.ESCALERA_FISCAL,
					PLANTA_FISCAL=v_varpad.PLANTA_FISCAL,
					PUERTA_FISCAL=v_varpad.PUERTA_FISCAL,
					COD_POSTAL_FISCAL=v_varpad.COD_POSTAL_FISCAL,
					APARTADO_CORREOS=v_varpad.APARTADO_CORREOS,
					PAIS=v_varpad.PAIS,
					PROVINCIA=v_varpad.PROVINCIA,
					MUNICIPIO_FISCAL=v_varpad.MUNICIPIO_FISCAL,
					TIPO_MOVIMIENTO=v_varpad.TIPO_MOVIMIENTO,
					YEAR_EXPEDIENTE=v_varpad.YEAR_EXPEDIENTE,
					REF_EXPEDIENTE=v_varpad.REF_EXPEDIENTE,
					EJERCICIO_ENTRADA_PADRON=v_varpad.EJER_ENTRADA,
					CLAVE_CATASTRAL_ANTERIOR=v_varpad.CLAVE_CATASTRAL,
					NIF_ANTERIOR=v_varpad.NIF_INTERIOR

	WHERE MUNICIPIO=xMUNICIPIO AND REF_CATASTRAL=v_varpad.REF_CATASTRAL 
	      AND NUM_CARGO=v_varpad.NUMERO_SECUENCIAL
		AND PRIMER_CARACTER_CONTROL=v_varpad.PRIMER_CARACTER_CONTROL 
		AND SEGUN_CARACTER_CONTROL=v_varpad.SEGUN_CARACTER_CONTROL;  


   END LOOP;

END;
/

/*********************************************************************************************/

CREATE OR REPLACE PROCEDURE BAJA_VARPAD(
	xMUNICIPIO	IN 	CHAR)
AS

	xFECHA_ALTERACION DATE DEFAULT NULL;
      CURSOR CVARPAD IS SELECT * FROM VARPAD WHERE MUNICIPIO=xMUNICIPIO
							   AND TIPO_MOVIMIENTO='B'
				ORDER BY FECHA_MOVIMIENTO,HORA_MOVIMIENTO;


BEGIN

   FOR v_varpad IN CVARPAD 
   LOOP

	if (v_varpad.FECHA_ALTERACION<>'00000000') then
	   xFECHA_ALTERACION:=TO_DATE(v_varpad.FECHA_ALTERACION,'yyyy/mm/dd');
	END IF;

      UPDATE IBI_CARGO_FURB SET 
					TIPO_MOVIMIENTO=v_varpad.TIPO_MOVIMIENTO,
					YEAR_EXPEDIENTE=v_varpad.YEAR_EXPEDIENTE,
					REF_EXPEDIENTE=v_varpad.REF_EXPEDIENTE,
					FECHA_BAJA=xFECHA_ALTERACION
	WHERE MUNICIPIO=xMUNICIPIO AND REF_CATASTRAL=v_varpad.REF_CATASTRAL 
	      AND NUM_CARGO=v_varpad.NUMERO_SECUENCIAL
		AND PRIMER_CARACTER_CONTROL=v_varpad.PRIMER_CARACTER_CONTROL 
		AND SEGUN_CARACTER_CONTROL=v_varpad.SEGUN_CARACTER_CONTROL;  

   END LOOP;

END;
/


/*********************************************************************************************/

CREATE OR REPLACE PROCEDURE CARGAR_VARPAD(
	xMUNICIPIO	IN	CHAR,
	xELIMINAR	IN	CHAR)
AS   

BEGIN

	ALTA_VARPAD(xMUNICIPIO);
	MODIFICACION_VARPAD(xMUNICIPIO);
	BAJA_VARPAD(xMUNICIPIO); 

	IF LTRIM(RTRIM(xELIMINAR))='S' THEN
         DELETE FROM VARPAD WHERE MUNICIPIO=xMUNICIPIO;
      END IF;

END;
/


/*********************************************************************************
Autor:  Antonio Pérez Caballero
Acción: Realizar un VARPAD98 de los cambios realizados en IBI.
        xQuienVaria este parametro no se utiliza por el momento.
MODIFICACIÓN: 18/02/2003 M. Carmen Junco Gómez. Se añade la fecha de alteración catastral.
MODIFICACIÓN: 24/02/2003 M. Carmen Junco Gómez. Si es CV02 -> nif_anterior es nulo.
MODIFICACIÓN: 19/02/2004 Gloria María Calle Hernández. 
				"Cambio tras hablar con Ricardo y alguien de Catastro de su parte"
			  Modificado procedimiento para que inserte en la tabla de VarPad 
			  todos los cambios no solo el último para cada bien urbano como antes hacia.
			  Modificado para que inserte en el campo Ref_expediente el ID de la tabla pues 
			  nunca debe repetirse, sino no lo leería Catastro.
MODIFICACIÓN: 02/03/2004 Gloria María Calle Hernández. 
			  "Cambio tras hablar con Ricardo y alguien de Catastro de su parte"
			  Modificado procedimiento de forma que cuando se trate de un CV02 rellene 
			  NIF_Interior (anterior) y Fecha_Alteracion sea nula. En los CV01 se rellena
			  Fecha_Alteracion obligatoriamente y NIF_Interior a nulo.
MODIFICACIÓN: 26/10/2004 Gloria María Calle Hernández. 
			  Añadido parámetro FechaHasta para Generar los cambios hasta al fecha indicada.
MODIFICACIÓN: 07/04/2006 Mª Carmen Junco Gómez. Cuando se carga el nuevo formato de IBI,
			  si se utiliza la Clase de Alteración, y esta vale EV03 o EN01, incluimos
			  una variación en la tabla HIS_CARGOREAL_IBI como consecuencia de la
			  rectificación enviada por catastro. Esto se indica con un valor 'C' para 
			  el campo QUIEN_VARIA. Este tipo de variación no se ha de incluir en las 
			  cinstas de VARPAD.
MODIFICACIÓN: 31/10/2006 Lucas Fernández Pérez. El coeficiente_finca en ibi es un float y a veces
				con los decimales toma 8 caracteres. Se trunca a 7 para que no falle.
**********************************************************************************/
CREATE OR REPLACE PROCEDURE VARPAD98_FROM_IBIMODI (xFechaHasta	IN  DATE)
AS
	-- Cursor con la lista de cambios realizados sin enviar a VARPAD98
	CURSOR cCAMBIOS IS SELECT * FROM HIS_CARGOREAL_IBI 
							 WHERE ULTIMA_VARIACION='N' AND QUIEN_VARIA<>'C' AND TRUNC(FECHA,'dd')<=TRUNC(xFechaHasta,'dd');
BEGIN

  FOR vCambios IN cCambios LOOP

    INSERT INTO VARPAD (MUNICIPIO,IDIBI,TIPO_REGISTRO,COD_DELEGACION_MEH,COD_GERENCIA,
    					COD_MUNICIPIO,REF_CATASTRAL,NUMERO_SECUENCIAL,PRIMER_CARACTER_CONTROL,SEGUN_CARACTER_CONTROL,
    					NUM_FIJO,LETRA_NUM_FIJO,IDENTIFICACION,COEFICIENTE_PARTICI,
    					COD_PROVI_INE,COD_MUNI_INE,DISTRITO_MUNI,
						-- Domicilio Tributario
						COD_ENTIDAD_MENOR,COD_VIA_PUBLICA,TIPO_VIA,NOMBRE_VIA,PRIMER_NUMERO,PRIMERA_LETRA,SEGUNDO_NUMERO,
						SEGUNDA_LETRA,KILOMETRO,BLOQUE,TEXTO_DIRECCION,CODIGO_POSTAL,ESCALERA,PLANTA,PUERTA,
						-- Identificacion del titular
						NIF,PERSONALIDAD,NOMBRE,
						COD_DEL_MEH,COD_MUNICIPIO_DGC,COD_PROVI_INE_FISCAL,COD_MUNI_INE_FISCAL,COD_VIA_PUBLICA_FISCAL,
						TIPO_VIA_FISCAL,NOMBRE_VIA_FISCAL,PRIMER_NUMERO_FISCAL,PRIMERA_LETRA_FISCAL,SEGUNDO_NUMERO_FISCAL,
						SEGUNDA_LETRA_FISCAL,KILOMETRO_FISCAL,BLOQUE_FISCAL,TEXTO_DIRECCION_FISCAL,ESCALERA_FISCAL,
						PLANTA_FISCAL,PUERTA_FISCAL,COD_POSTAL_FISCAL,APARTADO_CORREOS,PAIS,PROVINCIA,MUNICIPIO_FISCAL,
						-- Datos economicos del bien inmueble
						YEAR_VALOR_CATASTRAL,VALOR_CATASTRAL,VALOR_SUELO,VALOR_CONSTRUCCION,BASE_LIQUIDABLE,CLAVE_USO,
						YEAR_ULTIMA_REVISION,YEAR_ULTIMA_NOTIFICACION,NUM_ULTIMA_NOTIFICACION,
						SUPERFICIE_FINCAS,SUPERFICIE_SOLARES,COEFICIENTE_FINCA,
						-- Datos de movimiento
						TIPO_MOVIMIENTO,YEAR_EXPEDIENTE,REF_EXPEDIENTE,COD_ENTIDAD_COLA,EXISTENCIA_ALTERA,COD_MOVIMIENTO,
						FECHA_MOVIMIENTO,HORA_MOVIMIENTO,FECHA_ALTERACION,QUIEN_MODIFICA,NIF_INTERIOR)
						-- anterior

	SELECT 	MUNICIPIO,ID,'51',COD_DELEGACION_MEH,COD_GERENCIA,
		   	COD_MUNICIPIO,REF_CATASTRAL,NUMERO_SECUENCIAL,PRIMER_CARACTER_CONTROL,SEGUN_CARACTER_CONTROL,
			NUM_FIJO,LETRA_NUM_FIJO,IDENTIFICACION,COEFICIENTE_PARTICI,
			COD_PROVI_INE,COD_MUNI_INE,DISTRITO_MUNI,
			-- Domicilio Tributario
			COD_ENTIDAD_MENOR,COD_VIA_PUBLICA,TIPO_VIA,NOMBRE_VIA,PRIMER_NUMERO,PRIMERA_LETRA,SEGUNDO_NUMERO,
			SEGUNDA_LETRA,KILOMETRO,BLOQUE,TEXTO_DIRECCION,CODIGO_POSTAL,ESCALERA,PLANTA,PUERTA,
			-- Identificacion del titular
			SubStr(NIF, 1, 9),PERSONALIDAD,NOMBRE,COD_DEL_MEH,COD_MUNICIPIO_DGC,COD_PROVI_INE_FISCAL,COD_MUNI_INE_FISCAL,
			COD_VIA_PUBLICA_FISCAL,TIPO_VIA_FISCAL,NOMBRE_VIA_FISCAL,PRIMER_NUMERO_FISCAL,PRIMERA_LETRA_FISCAL,
			SEGUNDO_NUMERO_FISCAL,SEGUNDA_LETRA_FISCAL,KILOMETRO_FISCAL,BLOQUE_FISCAL,TEXTO_DIRECCION_FISCAL,ESCALERA_FISCAL,
			PLANTA_FISCAL,PUERTA_FISCAL,COD_POSTAL_FISCAL,APARTADO_CORREOS,PAIS,PROVINCIA,MUNICIPIO_FISCAL,
			-- Datos economicos del bien inmueble
			YEAR_VALOR_CATASTRAL,VALOR_CATASTRAL,VALOR_SUELO,VALOR_CONSTRUCCION,BASE_LIQUIDABLE,CLAVE_USO,
			YEAR_ULTIMA_REVISION,YEAR_ULTIMA_NOTIFICA,NUM_ULTIMA_NOTIFICA,
			SUPERFICIE_FINCAS,SUPERFICIE_SOLARES,SUBSTR(TO_CHAR(COEFICIENTE_FINCA),1,7),
			-- Datos de movimiento
			'M', -- TIPO_MOVIMIENTO A/B/M,
			TO_CHAR(vCambios.FECHA,'YYYY'), --YEAR_EXPEDIENTE
			LPAD(TO_CHAR(ID),13,'0'), --REF_EXPEDIENTE,
			COD_MUNICIPIO, --COD_ENTIDAD_COLABORADORA
			'N', -- Existe declaración de alteración
			vCambios.COD_MOTIVO,TO_CHAR(vCambios.FECHA,'YYYYMMDD'), --FECHA_MOVIMIENTO,
			TO_CHAR(vCambios.FECHA,'HHMMSS'),   -- HORA_MOVIMIENTO,
			DECODE(vCambios.COD_MOTIVO,'CV02',null,TO_CHAR(vCambios.FECHA_ALTERACION,'YYYYMMDD')), --FECHA DE ALTERACION CATASTRAL
			'A', 				    -- Quién modifica
			DECODE(vCambios.COD_MOTIVO,'CV02',substr(vCambios.NIF,1,9),'')	 --NIF ANTERIOR
	FROM IBI
	WHERE ID=vCambios.IDIBI;

	-- Indicamos cambio realizado
	UPDATE HIS_CARGOREAL_IBI SET ULTIMA_VARIACION='S'
	WHERE IDIBI=vCambios.IDIBI AND ULTIMA_VARIACION='N';

  END LOOP;

END;
/

