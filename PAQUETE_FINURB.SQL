/*********************************************************************/
--
-- Leer el fichero de la Ponencia de Valores de un Municipio
-- 
CREATE OR REPLACE PROCEDURE Read_PONUR_DGC (
	xAyto					IN  CHAR,
	xFileName		  		IN  CHAR,
	xPath					IN  CHAR,
	xNumReg					OUT INTEGER
) as
  vOutFile 				    UTL_FILE.FILE_TYPE;
  vReg						VARCHAR2(720);
  /* Identificacion de la Ponencia */
  xCOD_DELEGACION_MEH		CHAR(2);
  xCOD_MUNICIPIO_MEH		CHAR(3);
  xCOD_DELEGACION_INE		CHAR(2);
  xCOD_MUNICIPIO_INE		CHAR(3);
  xYEAR_APROBACION			CHAR(4);
  /* Datos del Tramo de Calle */
  xCOD_VIA_PUBLICA			CHAR(5);
  xCOD_TRAMO				CHAR(3);
  xDENOMINACION				CHAR(25);
  xCOD_POLIGONO				CHAR(3);
  xCOD_ZONA					CHAR(10);
  xSITUACION_PLANO			CHAR(10);
  xMAX_NUM_PAR				CHAR(4);
  xCARAC_DUPLICADO_XP		CHAR(1);
  xMIN_NUM_PAR				CHAR(4);
  xCARAC_DUPLICADO_MP		CHAR(1);
  xMAX_NUM_IMPAR			CHAR(4);
  xCARAC_DUPLICADO_XI		CHAR(1);
  xMIN_NUM_IMPAR			CHAR(4);
  xCARAC_DUPLICADO_MI		CHAR(1);
  /* Datos de Valoracion */
  xVALOR_UNITARIO		 	CHAR(11);
  xCOEF_BANDA_COMERCIAL		FLOAT;
  xCOEF_BANDA_RESIDENCIAL	FLOAT;
  xCOEF_BANDA_OFICINAS		FLOAT;
  xCOEF_BANDA_INDUSTRIAL	FLOAT;
  xCOEF_BANDA_TURISTICO		FLOAT;
  xCOEF_BANDA_USOS1			FLOAT;
  xCOEF_BANDA_USOS2			FLOAT;
  xCOEF_BANDA_USOS3			FLOAT;
  xCOEF_CORRECTOR_SUELO		FLOAT;
  xCOEF_CORRECTOR_CONSTR	FLOAT;
  xINDICADOR_METODO			CHAR(1);
  xINDICADOR_GRADO_AGUA		CHAR(1);
  xINDICADOR_GRADO_ELECT	CHAR(1);
  xINDICADOR_GRADO_ALUMB	CHAR(1);
  xINDICADOR_GRADO_DESMON	CHAR(1);
  xINDICADOR_GRADO_PAVIM	CHAR(1);
  xINDICADOR_GRADO_ALCAN	CHAR(1);
  xIMPORTE_COSTES			FLOAT;

  PROCEDURE recNgo (str IN VARCHAR2)
  IS
  BEGIN
     DBMS_OUTPUT.PUT_LINE ('UTL_FILE error ' || str);
     UTL_FILE.FCLOSE (vOutFile);
  END;

begin

   vOutFile:=UTL_FILE.FOPEN(trim(xPath),trim(xFileName),'R');
   
   xNumReg:=0;

   LOOP
   BEGIN

	  UTL_FILE.GET_LINE(vOutFile,vReg);

      IF (SUBSTR(vReg,1,2)='05') THEN
  	  	 /* Identificacion de la Ponencia */
		 xCOD_DELEGACION_MEH:= SUBSTR(vReg,3,2);
		 xCOD_MUNICIPIO_MEH:= SUBSTR(vReg,5,3);
		 xCOD_DELEGACION_INE:= SUBSTR(vReg,8,2);
  		 xCOD_MUNICIPIO_INE:= SUBSTR(vReg,10,3);
  		 xYEAR_APROBACION:= SUBSTR(vReg,13,4);
  		 /* Datos del Tramo de Calle */
  		 xCOD_VIA_PUBLICA:= SUBSTR(vReg,17,5);
  		 xCOD_TRAMO:= SUBSTR(vReg,22,3);
  		 xDENOMINACION:= SUBSTR(vReg,25,25);
  		 xCOD_POLIGONO:= SUBSTR(vReg,50,3);
		 xCOD_ZONA:= SUBSTR(vReg,53,10);
		 xSITUACION_PLANO:= SUBSTR(vReg,63,10);
		 xMAX_NUM_PAR:= SUBSTR(vReg,73,4);
		 xCARAC_DUPLICADO_XP:= SUBSTR(vReg,77,1);
		 xMIN_NUM_PAR:= SUBSTR(vReg,78,4);
		 xCARAC_DUPLICADO_MP:= SUBSTR(vReg,82,1);
		 xMAX_NUM_IMPAR:= SUBSTR(vReg,83,4);
		 xCARAC_DUPLICADO_XI:= SUBSTR(vReg,87,1);
		 xMIN_NUM_IMPAR:= SUBSTR(vReg,88,4);
		 xCARAC_DUPLICADO_MI:= SUBSTR(vReg,92,1);
		 /* Datos de Valoracion */
		 xVALOR_UNITARIO:= SUBSTR(vReg,93,11);
		 xCOEF_BANDA_COMERCIAL:= TO_NUMBER(TRIM(SUBSTR(vReg,104,4)))/100;
		 xCOEF_BANDA_RESIDENCIAL:= TO_NUMBER(TRIM(SUBSTR(vReg,108,4)))/100;
		 xCOEF_BANDA_OFICINAS:= TO_NUMBER(TRIM(SUBSTR(vReg,112,4)))/100;
		 xCOEF_BANDA_INDUSTRIAL:= TO_NUMBER(TRIM(SUBSTR(vReg,116,4)))/100;
		 xCOEF_BANDA_TURISTICO:= TO_NUMBER(TRIM(SUBSTR(vReg,120,4)))/100;
		 xCOEF_BANDA_USOS1:= TO_NUMBER(TRIM(SUBSTR(vReg,124,4)))/100;
		 xCOEF_BANDA_USOS2:= TO_NUMBER(TRIM(SUBSTR(vReg,128,4)))/100;
		 xCOEF_BANDA_USOS3:= TO_NUMBER(TRIM(SUBSTR(vReg,132,4)))/100;
		 xCOEF_CORRECTOR_SUELO:= TO_NUMBER(TRIM(SUBSTR(vReg,136,3)))/100;
		 xCOEF_CORRECTOR_CONSTR:= TO_NUMBER(TRIM(SUBSTR(vReg,139,3)))/100;
		 xINDICADOR_METODO:= SUBSTR(vReg,142,1);
		 xINDICADOR_GRADO_AGUA:= SUBSTR(vReg,143,1);
		 xINDICADOR_GRADO_ELECT:= SUBSTR(vReg,144,1);
		 xINDICADOR_GRADO_ALUMB:= SUBSTR(vReg,145,1);
		 xINDICADOR_GRADO_DESMON:= SUBSTR(vReg,146,1);
		 xINDICADOR_GRADO_PAVIM:= SUBSTR(vReg,147,1);
		 xINDICADOR_GRADO_ALCAN:= SUBSTR(vReg,148,1);
		 xIMPORTE_COSTES:= TO_NUMBER(TRIM(SUBSTR(vReg,149,10)))/100;


		 INSERT INTO IBI_PONUR_DGC
		 (MUNICIPIO,
	     /* Identificacion de la Ponencia */
		  COD_DELEGACION_MEH,COD_MUNICIPIO_MEH,COD_DELEGACION_INE,COD_MUNICIPIO_INE,YEAR_APROBACION,
		 /* Datos del Tramo de Calle */
  		  COD_VIA_PUBLICA,COD_TRAMO,DENOMINACION,COD_POLIGONO,COD_ZONA,SITUACION_PLANO,
		  MAX_NUM_PAR,CARAC_DUPLICADO_XP,MIN_NUM_PAR,CARAC_DUPLICADO_MP,MAX_NUM_IMPAR,CARAC_DUPLICADO_XI,MIN_NUM_IMPAR,CARAC_DUPLICADO_MI,
		 /* Datos de Valoracion */
		  VALOR_UNITARIO,COEF_BANDA_COMERCIAL,COEF_BANDA_RESIDENCIAL,COEF_BANDA_OFICINAS,COEF_BANDA_INDUSTRIAL,
		  COEF_BANDA_TURISTICO,COEF_BANDA_USOS1,COEF_BANDA_USOS2,COEF_BANDA_USOS3,COEF_CORRECTOR_SUELO,COEF_CORRECTOR_CONSTR,
		  INDICADOR_METODO,INDICADOR_GRADO_AGUA,INDICADOR_GRADO_ELECT,INDICADOR_GRADO_ALUMB,INDICADOR_GRADO_DESMON,INDICADOR_GRADO_PAVIM,
		  INDICADOR_GRADO_ALCAN,IMPORTE_COSTES)
		 VALUES
		 (TRIM(xAyto),
	     /* Identificacion de la Ponencia */
		  xCOD_DELEGACION_MEH,xCOD_MUNICIPIO_MEH,xCOD_DELEGACION_INE,xCOD_MUNICIPIO_INE,xYEAR_APROBACION,
		 /* Datos del Tramo de Calle */
  		  xCOD_VIA_PUBLICA,xCOD_TRAMO,xDENOMINACION,xCOD_POLIGONO,xCOD_ZONA,xSITUACION_PLANO,
		  xMAX_NUM_PAR,xCARAC_DUPLICADO_XP,xMIN_NUM_PAR,xCARAC_DUPLICADO_MP,xMAX_NUM_IMPAR,xCARAC_DUPLICADO_XI,xMIN_NUM_IMPAR,xCARAC_DUPLICADO_MI,
		 /* Datos de Valoracion */
		  xVALOR_UNITARIO,xCOEF_BANDA_COMERCIAL,xCOEF_BANDA_RESIDENCIAL,xCOEF_BANDA_OFICINAS,xCOEF_BANDA_INDUSTRIAL,
		  xCOEF_BANDA_TURISTICO,xCOEF_BANDA_USOS1,xCOEF_BANDA_USOS2,xCOEF_BANDA_USOS3,xCOEF_CORRECTOR_SUELO,xCOEF_CORRECTOR_CONSTR,
		  xINDICADOR_METODO,xINDICADOR_GRADO_AGUA,xINDICADOR_GRADO_ELECT,xINDICADOR_GRADO_ALUMB,xINDICADOR_GRADO_DESMON,xINDICADOR_GRADO_PAVIM,
		  xINDICADOR_GRADO_ALCAN,xIMPORTE_COSTES);
		  
		  xNumReg:= xNumReg+1;

	  END IF;

  	  EXCEPTION
	  WHEN NO_DATA_FOUND THEN
	   	  EXIT;
	  END;

   END LOOP;

   UTL_FILE.FCLOSE(vOutFile);

   EXCEPTION
   	  WHEN NO_DATA_FOUND
    	THEN recNgo ('no_data_found');
      WHEN UTL_FILE.INVALID_PATH
       THEN recNgo ('invalid_path');
      WHEN UTL_FILE.INVALID_MODE
       THEN recNgo ('invalid_mode');
      WHEN UTL_FILE.INVALID_FILEHANDLE
       THEN recNgo ('invalid_filehandle');
      WHEN UTL_FILE.INVALID_OPERATION
       THEN recNgo ('invalid_operation');
      WHEN UTL_FILE.READ_ERROR
       THEN recNgo ('read_error');
      WHEN UTL_FILE.WRITE_ERROR
       THEN recNgo ('write_error');
      WHEN UTL_FILE.INTERNAL_ERROR
       THEN recNgo ('internal_error');
	  WHEN VALUE_ERROR
	   THEN recNgo ('value_error');
	  WHEN OTHERS
	   THEN recNgo (To_Char(SQLCODE)||SQLERRM);

   COMMIT;
END Read_PONUR_DGC;
/



/*********************************************************************/




/****************************************************************************************************
AUTOR: Agustín Léon Robles 01/07/2004
FUNCION: Procedimientos para el tratamiento del formato FINURB
*****************************************************************************************************/

CREATE OR REPLACE PACKAGE PkFinUrb
AS
  
	PROCEDURE Inserta_Reg_Finca(xDelegacionMEH in char, xGerencia in char, xAyto in char,vRegFinca in varchar2);
	PROCEDURE Inserta_Reg_Suelo(xDelegacionMEH in char, xGerencia in char, xAyto in char,vRegFinca in varchar2);
	PROCEDURE Inserta_Reg_Unidad_Construc(xDelegacionMEH in char, xGerencia in char, xAyto in char,vRegFinca in varchar2);
	PROCEDURE Inserta_Reg_Construccion(xDelegacionMEH in char, xGerencia in char, xAyto in char,vRegFinca in varchar2, xPrincipal in varchar2);	
	PROCEDURE Inserta_Reg_Unidad_Cargo(xDelegacionMEH in char, xGerencia in char, xAyto in char,vRegFinca in varchar2);
	PROCEDURE Inserta_Reparto_Elementos(xDelegacionMEH in char, xGerencia in char, xAyto in char,vRegFinca in varchar2);
	PROCEDURE Baja_Reg_Finca(
				xID in integer,
				xYEAR_EXPEDIENTE 			in CHAR,
				xREF_EXPEDIENTE				in CHAR,
				xCOD_ENTIDAD_ORIGEN_EXPE	in CHAR,
				xEXISTE_DECLARA_ALTERACION	in CHAR,
				xCOD_MOTIVO_MOVIMIENTO		in CHAR,
				xFECHA_MOVIMIENTO			in DATE,	
				xHORA_MOVIMIENTO			in CHAR,
				xFECHA_ALTERA_CATASTRAL		in DATE);
				
				
	--Insertar Registro 11
	PROCEDURE Alta_Finca_Nueva(
				xDelegacionMEH 				in  VARCHAR2,
				xGerencia 					in  VARCHAR2,
				xMunicipio					IN	VARCHAR2,
				xREF_CATASTRAL				IN	VARCHAR2,
				xDISTRITO_CENSAL			IN 	VARCHAR2,
				xCOD_ENTIDAD_MENOR			IN 	VARCHAR2,
				xCOD_VIA_PUBLICA			IN 	VARCHAR2,
				xTIPO_VIA					IN 	VARCHAR2,
				xNOMBRE_VIA					IN 	VARCHAR2,
				xPRIMER_NUMERO				IN 	VARCHAR2,
				xPRIMERA_LETRA				IN 	VARCHAR2,	
				xSEGUNDO_NUMERO				IN 	VARCHAR2,
				xSEGUNDA_LETRA				IN 	VARCHAR2,
				xKILOMETRO					IN 	VARCHAR2,	
				xBLOQUE						IN 	VARCHAR2,
				xTEXTO_DIRECCION			IN 	VARCHAR2,
				xCODIGO_POSTAL				IN 	VARCHAR2,	
				xSUPERFICIE_SOLARES			IN 	VARCHAR2,
				xSUPERFICIE_FINCAS			IN 	VARCHAR2,
				xSUPERF_SOBRE_RASANTE		IN 	VARCHAR2,
				xSUPERF_BAJO_RASANTE		IN 	VARCHAR2,
				xSUPERF_CUBIERTA			IN 	VARCHAR2,				
				xCOD_CALCULO_VALOR_CAT		IN 	VARCHAR2,
				xEDIFICABILIDAD				IN 	VARCHAR2,
				xEXIS_INFOR_CARTAGRAFICA	IN 	VARCHAR2,
				xDESCRIP_ALTER_CATASTRAL	IN 	VARCHAR2,
				xTIPO_MOVIMIENTO			IN 	VARCHAR2,
				xYEAR_EXPEDIENTE			IN 	VARCHAR2,
				xREF_EXPEDIENTE				IN 	VARCHAR2,
				xCOD_ENTIDAD_ORIGEN_EXPE	IN 	VARCHAR2,
				xEXISTE_DECLARA_ALTERACION	IN 	VARCHAR2,
				xCOD_MOTIVO_MOVIMIENTO		IN 	VARCHAR2,
				xFECHA_MOVIMIENTO			IN	DATE,	
				xHORA_MOVIMIENTO			IN 	DATE,
				xFECHA_ALTERA_CATASTRAL		IN	DATE);
				
	--Insertar Registro 12
	PROCEDURE Alta_Suelo_Nueva(
				xDelegacionMEH 					in  VARCHAR2,
				xGerencia 						in  VARCHAR2,
				xMUNICIPIO						IN VARCHAR2,
				xREF_CATASTRAL					IN VARCHAR2,
				xLONG_FACHADA					IN FLOAT,
				xTIPO_FACHADA					IN VARCHAR2,
				xSUPERFICIE_SUELO				IN FLOAT,
				xFONDO_SUELO					IN FLOAT,
				xCOD_VA_PUBLICA					IN VARCHAR2,
				xCOD_TRAMO_VIA					IN VARCHAR2,
				xCOD_TIPO_VALOR					IN VARCHAR2,
				xNUM_FACHADAS					IN VARCHAR2,
				xAPLICA_COEF_LONG_FACHADA		IN VARCHAR2,	
				xAPLICA_COEF_FORMA_IRREGU		IN VARCHAR2,
				xAPLICA_COEF_DESMONTE_EXCESIVO	IN VARCHAR2,
				xAPLICA_COEF_PROFUN_FIRME		IN VARCHAR2,
				xAPLICA_COEF_FONDO_EXCESIVO		IN VARCHAR2,
				xAPLICA_COEF_SUPERF_NO_MIN		IN VARCHAR2,
				xAPLICA_COEF_INEDIFICABILIDAD	IN VARCHAR2,
				xAPLICA_COEF_SUELO_PROTEC_PUB	IN VARCHAR2,
				xCOEF_CORRECTOR					IN VARCHAR2,
    		  	xAPLICA_COEF_DEPRECIACION		IN VARCHAR2,
				xCOEF_FINCA_CARGAS_SINGULARES	IN VARCHAR2,
				xAPLICA_COEF_SITU_ESPECIAL     	IN VARCHAR2,
				xAPLICA_COEF_USO_NO_LUCRATIVO	IN VARCHAR2,
				xTIPO_MOVIMIENTO				IN VARCHAR2,
				xYEAR_EXPEDIENTE				IN VARCHAR2,
				xREF_EXPEDIENTE					IN VARCHAR2,
				xCOD_ENTIDAD_COLABORADORA		IN VARCHAR2,
				xF_ALTERACION_CATASTRAL			IN DATE);

	--Insertar Registro 14
	PROCEDURE Alta_Construccion_Nueva(
				xMUNICIPIO						IN VARCHAR2,
				xREF_CATASTRAL					IN VARCHAR2,
				xNUM_CARGO						IN VARCHAR2,
				xCOD_UNIDAD_CONSTRUCTIVA		IN VARCHAR2,
				xBLOQUE							IN VARCHAR2,
				xESCALERA						IN VARCHAR2,
				xPLANTA							IN VARCHAR2,
				xPUERTA							IN VARCHAR2,
				xCOD_DESTINO					IN VARCHAR2,
				xTIPO_REFORMA					IN VARCHAR2,
				xYEAR_REFORMA					IN VARCHAR2,
				xLOCAL_INTERIOR					IN VARCHAR2,
				xSUPERFICIE_TOTAL_LOCAL			IN FLOAT,
				xSUPERFICIE_PORCHES_TERR		IN FLOAT,
				xSUPERFICIE_LOCAL_OTRAS_PL		IN FLOAT,	
				xTIPOLOGIA_CONSTRUCTIVA			IN VARCHAR2,
				xCOD_USO						IN VARCHAR2,
				xCOD_CATEGORIA					IN VARCHAR2,
				xCOD_MODALIDAD_REPARTO			IN VARCHAR2,
				xCOD_TIPO_VALOR_APLICAR			IN VARCHAR2,
				xCOEF_CORRECTOR					IN VARCHAR2,
    			xAPLICA_COEFICIENTE  			IN VARCHAR2,
    			xPRINCIPAL						IN VARCHAR2);

	--Insertar Registro 13
	PROCEDURE Alta_Unidad_Constructiva_Nueva(
				xMUNICIPIO						IN VARCHAR2,
				xREF_CATASTRAL					IN VARCHAR2,
				xCOD_UNIDAD_CONSTRUCTIVA		IN VARCHAR2,	
				xCOD_ENTIDAD_MENOR				IN VARCHAR2,
				xCOD_VIA_PUBLICA				IN VARCHAR2,
				xTIPO_VIA						IN VARCHAR2,
				xNOMBRE_VIA						IN VARCHAR2,
				xPRIMER_NUMERO					IN VARCHAR2,
				xPRIMERA_LETRA					IN VARCHAR2,
				xSEGUNDO_NUMERO					IN VARCHAR2,
				xSEGUNDA_LETRA					IN VARCHAR2,
				xKILOMETRO						IN VARCHAR2,
				xBLOQUE							IN VARCHAR2,
				xTEXTO_DIRECCION				IN VARCHAR2,
				xCODIGO_POSTAL					IN VARCHAR2,	
				xYEAR_CONSTRUCCION				IN VARCHAR2,
				xLONG_FACHADA					IN VARCHAR2,
				xUSO_AGRARIO_LOCALES_ASOC		IN VARCHAR2,
				xCOD_VA_PUBLICA_PONENCIA		IN VARCHAR2,
				xCOD_TRAMO_VIA					IN VARCHAR2,	
				xNUM_FACHADAS					IN VARCHAR2,
				xAPLICA_COEF_LONG_FACHADA		IN VARCHAR2,
				xCOD_COEF_ESTADO_CONSERVA		IN VARCHAR2,	
    			xAPLICA_COEF_DEPRECIACION		IN VARCHAR2,
				xCOEF_CORRECTOR					IN VARCHAR2,
				xAPLICA_COEF_SITU_ESPECIAL   	IN VARCHAR2,
				xAPLICA_COEF_USO_NO_LUCRATIVO	IN VARCHAR2,	
				xEXACTITUD_YEAR_CONSTRUCCION	IN VARCHAR2);

				
	--Insertar registro 15
	PROCEDURE Alta_Registro_Cargo_Nueva(
		xMUNICIPIO						IN VARCHAR2,
		xREF_CATASTRAL					IN VARCHAR2,
		xCOEF_PARTICIPACION				IN VARCHAR2,
		xNIF							IN VARCHAR2,
		xPERSONALIDAD					IN VARCHAR2,
		xNOMBRE							IN VARCHAR2,
		xNUM_COMPONENTES				IN VARCHAR2,
		xCOMPLEMENTO_NOMBRE				IN VARCHAR2,
		xCOD_DEL_MEH					IN VARCHAR2,
		xCOD_MUNICIPIO_DGC				IN VARCHAR2,
		xCOD_PROVI_INE_FISCAL			IN VARCHAR2,
		xCOD_MUNI_INE_FISCAL			IN VARCHAR2,
		xCOD_VIA_PUBLICA_FISCAL			IN VARCHAR2,
		xTIPO_VIA_FISCAL				IN VARCHAR2,
		xNOMBRE_VIA_FISCAL				IN VARCHAR2,
		xPRIMER_NUMERO_FISCAL			IN VARCHAR2,
		xPRIMERA_LETRA_FISCAL			IN VARCHAR2,
		xSEGUNDO_NUMERO_FISCAL			IN VARCHAR2,
		xSEGUNDA_LETRA_FISCAL			IN VARCHAR2,
		xKILOMETRO_FISCAL				IN VARCHAR2,
		xBLOQUE_FISCAL					IN VARCHAR2,
		xTEXTO_DIRECCION_FISCAL			IN VARCHAR2,
		xESCALERA_FISCAL				IN VARCHAR2,
		xPLANTA_FISCAL					IN VARCHAR2,
		xPUERTA_FISCAL					IN VARCHAR2,
		xCOD_POSTAL_FISCAL				IN VARCHAR2,
		xAPARTADO_CORREOS				IN VARCHAR2,
		xPAIS							IN VARCHAR2,
		xPROVINCIA						IN VARCHAR2,
		xMUNICIPIO_FISCAL				IN VARCHAR2,
		xYEAR_VALOR_CATASTRAL			IN VARCHAR2,
		xVALOR_CATASTRAL				IN FLOAT,
		xVALOR_SUELO					IN FLOAT,
		xVALOR_CONSTRUCCION				IN FLOAT,
		xBASE_LIQUIDABLE				IN FLOAT,
		xCLAVE_USO						IN VARCHAR2,
		xYEAR_ULTIMA_REVISION			IN VARCHAR2,
		xYEAR_ULTIMA_NOTIFICACION		IN VARCHAR2,
		xNUM_ULTIMA_NOTI				IN VARCHAR2,
		xSUPERF_ELEM_CONSTRUCTIVOS		IN FLOAT,
		xSUPERFICIE_ELEM_SUELO			IN FLOAT,
		xCOEFICIENTE_FINCA				IN VARCHAR2,
		xAPLICA_PRECIO_MAX_ADMIN		IN VARCHAR2,
		xYEAR_FIN_PRECIO_MAX_ADMIN		IN VARCHAR2,
		xTIPO_PROPIEDAD_CARGO			IN VARCHAR2,		
		xEJERCICIO_ENTRADA_PADRON		IN VARCHAR2,
		xIDReg14						IN INTEGER);
				
				
    --
	--
	-- Eliminar un registro de suelo manualmente desde Delphi. Hay que recalcular los metros del solar y actualizar en la tabla de Finca
	--
	PROCEDURE Del_Registro_Suelo(
				xID					IN INTEGER,
				xMUNICIPIO			IN VARCHAR2,
				xREF_CATASTRAL		IN VARCHAR2);
			
				
							
	-- Lee desde oracle cada campo en el fichero FINURB y lo inserta en las tablas del FINURB
	PROCEDURE IBI_FINURB_READ (
			xAyto		IN  VARCHAR2,
			xFileName	IN  VARCHAR2,
			xPath		IN  VARCHAR2,
			xNumReg		OUT	INTEGER,
			xError		OUT	VARCHAR2); 

  
END PkFinUrb;
/


CREATE OR REPLACE PACKAGE BODY PkFinUrb
AS



--
--Dar de Baja el registro de Finca, esto significa que se dará de baja todos los registros y solamente se comunicará al catastro
--este registro el resto se ignoran
--
PROCEDURE Baja_Reg_Finca(
				xID 						in integer,
				xYEAR_EXPEDIENTE 			in CHAR,
				xREF_EXPEDIENTE				in CHAR,
				xCOD_ENTIDAD_ORIGEN_EXPE	in CHAR,
				xEXISTE_DECLARA_ALTERACION	in CHAR,
				xCOD_MOTIVO_MOVIMIENTO		in CHAR,
				xFECHA_MOVIMIENTO			in DATE,	
				xHORA_MOVIMIENTO			in CHAR,
				xFECHA_ALTERA_CATASTRAL		in DATE)
as
	xRefCatastral	varchar2(14);
begin


	
	--Registro de Finca				
	UPDATE IBI_FINCA_FURB SET TIPO_MOVIMIENTO='B',
			YEAR_EXPEDIENTE=xYEAR_EXPEDIENTE,
			REF_EXPEDIENTE=xREF_EXPEDIENTE,
			COD_ENTIDAD_ORIGEN_EXPE=xCOD_ENTIDAD_ORIGEN_EXPE,
			EXISTE_DECLARA_ALTERACION=xEXISTE_DECLARA_ALTERACION,
			COD_MOTIVO_MOVIMIENTO=xCOD_MOTIVO_MOVIMIENTO,
			FECHA_MOVIMIENTO=xFECHA_MOVIMIENTO,	
			HORA_MOVIMIENTO=REPLACE(xHORA_MOVIMIENTO,':',''),
			FECHA_ALTERA_CATASTRAL=xFECHA_ALTERA_CATASTRAL
	WHERE ID=xID
	RETURNING REF_CATASTRAL INTO xRefCatastral;
	
	
	--Registro de Suelo
	UPDATE IBI_SUELO_FURB SET 
			TIPO_MOVIMIENTO='B',
			YEAR_EXPEDIENTE=xYEAR_EXPEDIENTE,
			REF_EXPEDIENTE=xREF_EXPEDIENTE,
			COD_ENTIDAD_COLABORADORA=xCOD_ENTIDAD_ORIGEN_EXPE,
			F_ALTERACION_CATASTRAL=xFECHA_ALTERA_CATASTRAL
	WHERE REF_CATASTRAL=xRefCatastral;
	
	
	--Registro de Unidad Constructiva
	UPDATE IBI_CONSTRUCTIVA_FURB SET 
			TIPO_MOVIMIENTO='B',
			YEAR_EXPEDIENTE=xYEAR_EXPEDIENTE,
			REF_EXPEDIENTE=xREF_EXPEDIENTE,
			COD_ENTIDAD_COLABORADORA=xCOD_ENTIDAD_ORIGEN_EXPE,			
			F_ALTERACION_CATASTRAL=xFECHA_ALTERA_CATASTRAL
	WHERE REF_CATASTRAL=xRefCatastral;
	
	
	--Registro de Construcción
	UPDATE IBI_CONSTRUCCION_FURB SET 
			TIPO_MOVIMIENTO='B',
			YEAR_EXPEDIENTE=xYEAR_EXPEDIENTE,
			REF_EXPEDIENTE=xREF_EXPEDIENTE,
			COD_ENTIDAD_COLABORADORA=xCOD_ENTIDAD_ORIGEN_EXPE,			
			F_ALTERACION_CATASTRAL=xFECHA_ALTERA_CATASTRAL
	WHERE REF_CATASTRAL=xRefCatastral;
	
	--Registro de Cargo o Unidad Fiscal
	UPDATE IBI_CARGO_FURB SET 
			TIPO_MOVIMIENTO='B',
			YEAR_EXPEDIENTE=xYEAR_EXPEDIENTE,
			REF_EXPEDIENTE=xREF_EXPEDIENTE,
			COD_ENTIDAD_COLABORADORA=xCOD_ENTIDAD_ORIGEN_EXPE,			
			F_ALTERACION_CATASTRAL=xFECHA_ALTERA_CATASTRAL
	WHERE REF_CATASTRAL=xRefCatastral;	
	
		
	--Registro de Reparto de elementos de construcción comunes entre elementos normales
	UPDATE IBI_REPARTO_CONSTRUCCION_FURB SET 
			TIPO_MOVIMIENTO='B',
			YEAR_EXPEDIENTE=xYEAR_EXPEDIENTE,
			REF_EXPEDIENTE=xREF_EXPEDIENTE,
			COD_ENTIDAD_COLABORADORA=xCOD_ENTIDAD_ORIGEN_EXPE,			
			F_ALTERACION_CATASTRAL=xFECHA_ALTERA_CATASTRAL
	WHERE REF_CATASTRAL=xRefCatastral;	
	
end;


--
-- Insertar desde Delphi un registro de Finca de Alta
--
-- Registro 11
--
PROCEDURE Alta_Finca_Nueva(
		xDelegacionMEH 				in  VARCHAR2,
		xGerencia 					in  VARCHAR2,
		xMunicipio					IN	VARCHAR2,
		xREF_CATASTRAL				IN	VARCHAR2,
		xDISTRITO_CENSAL			IN 	VARCHAR2,
		xCOD_ENTIDAD_MENOR			IN 	VARCHAR2,
		xCOD_VIA_PUBLICA			IN 	VARCHAR2,
		xTIPO_VIA					IN 	VARCHAR2,
		xNOMBRE_VIA					IN 	VARCHAR2,
		xPRIMER_NUMERO				IN 	VARCHAR2,
		xPRIMERA_LETRA				IN 	VARCHAR2,	
		xSEGUNDO_NUMERO				IN 	VARCHAR2,
		xSEGUNDA_LETRA				IN 	VARCHAR2,
		xKILOMETRO					IN 	VARCHAR2,	
		xBLOQUE						IN 	VARCHAR2,
		xTEXTO_DIRECCION			IN 	VARCHAR2,
		xCODIGO_POSTAL				IN 	VARCHAR2,	
		xSUPERFICIE_SOLARES			IN 	VARCHAR2,
		xSUPERFICIE_FINCAS			IN 	VARCHAR2,
		xSUPERF_SOBRE_RASANTE		IN 	VARCHAR2,
		xSUPERF_BAJO_RASANTE		IN 	VARCHAR2,
		xSUPERF_CUBIERTA			IN 	VARCHAR2,		
		xCOD_CALCULO_VALOR_CAT		IN 	VARCHAR2,
		xEDIFICABILIDAD				IN 	VARCHAR2,
		xEXIS_INFOR_CARTAGRAFICA	IN 	VARCHAR2,
		xDESCRIP_ALTER_CATASTRAL	IN 	VARCHAR2,
		xTIPO_MOVIMIENTO			IN 	VARCHAR2,
		xYEAR_EXPEDIENTE			IN 	VARCHAR2,
		xREF_EXPEDIENTE				IN 	VARCHAR2,
		xCOD_ENTIDAD_ORIGEN_EXPE	IN 	VARCHAR2,
		xEXISTE_DECLARA_ALTERACION	IN 	VARCHAR2,
		xCOD_MOTIVO_MOVIMIENTO		IN 	VARCHAR2,
		xFECHA_MOVIMIENTO			IN	DATE,	
		xHORA_MOVIMIENTO			IN 	DATE,
		xFECHA_ALTERA_CATASTRAL		IN	DATE)
as
vRegFinca					varchar2(720);
vTipoVia					char(5);
vDISTRITO_CENSAL			char(2);
vCOD_ENTIDAD_MENOR			char(2);
vPRIMERA_LETRA				char(1);
vSEGUNDO_NUMERO				char(4);
vSEGUNDA_LETRA				char(1);
vKILOMETRO					char(5);
vBLOQUE						char(4);
vTEXTO_DIRECCION			char(25);
vDESCRIP_ALTER_CATASTRAL	char(200);
begin



		if TRIM(xDISTRITO_CENSAL) is null then
			vDISTRITO_CENSAL:='00';
		else
			vDISTRITO_CENSAL:=LPAD(TRIM(xDISTRITO_CENSAL),2,0);
		end if;
		
		if TRIM(xCOD_ENTIDAD_MENOR) is null then
			vCOD_ENTIDAD_MENOR:='  ';
		else
			vCOD_ENTIDAD_MENOR:=RPAD(TRIM(xCOD_ENTIDAD_MENOR),2,' ');
		end if;
		
		if TRIM(xTIPO_VIA) is null then
			vTipoVia:='     ';
		else
			vTipoVia:=RPAD(TRIM(xTIPO_VIA),5,' ');
		end if;
		
		if TRIM(xPRIMERA_LETRA) is null then
			vPRIMERA_LETRA:=' ';
		else
			vPRIMERA_LETRA:=xPRIMERA_LETRA;
		end if;
		
		if TRIM(xSEGUNDO_NUMERO) is null then
			vSEGUNDO_NUMERO:='0000';
		else
			vSEGUNDO_NUMERO:=LPAD(TRIM(xSEGUNDO_NUMERO),4,0);
		end if;
		
		if TRIM(xSEGUNDA_LETRA) is null then
			vSEGUNDA_LETRA:=' ';
		else
			vSEGUNDA_LETRA:=xSEGUNDA_LETRA;
		end if;

		if TRIM(xKILOMETRO) is null then
			vKILOMETRO:='00000';
		else
			vKILOMETRO:=LPAD(TRIM(xKILOMETRO),5,0);
		end if;
		
		if TRIM(xBLOQUE) is null then
			vBLOQUE:='    ';
		else
			vBLOQUE:=RPAD(TRIM(xBLOQUE),4,' ');
		end if;
		
		if TRIM(xTEXTO_DIRECCION) is null then
			vTEXTO_DIRECCION:=LPAD(' ',25,' ');  
		else
			vTEXTO_DIRECCION:=RPAD(TRIM(xTEXTO_DIRECCION),25,' ');
		end if;
		
		if TRIM(xDESCRIP_ALTER_CATASTRAL) is null then
			vDESCRIP_ALTER_CATASTRAL:=LPAD(' ',200,' ');
		else
			vDESCRIP_ALTER_CATASTRAL:=RPAD(RTRIM(xDESCRIP_ALTER_CATASTRAL),200,' ');
		end if;
		
		vRegFinca:='11'||RPAD(xREF_CATASTRAL,14,' ')||LPAD(' ',40,' ')||vDISTRITO_CENSAL||vCOD_ENTIDAD_MENOR
					||LPAD(TRIM(xCOD_VIA_PUBLICA),5,0)||vTipoVia||RPAD(xNOMBRE_VIA,25,' ')||LPAD(TRIM(xPRIMER_NUMERO),4,0)
					||vPRIMERA_LETRA||vSEGUNDO_NUMERO||vSEGUNDA_LETRA||vKILOMETRO||vBLOQUE||vTEXTO_DIRECCION||LPAD(TRIM(xCODIGO_POSTAL),5,0)
					||LPAD(TRIM(xSUPERFICIE_SOLARES),7,0)
					||LPAD(TRIM(xSUPERFICIE_FINCAS),7,0)||LPAD(TRIM(xSUPERF_SOBRE_RASANTE),7,0)||LPAD(TRIM(xSUPERF_BAJO_RASANTE),7,0)
					||LPAD(TRIM(xSUPERF_CUBIERTA),7,0)||LPAD(0,4,0)||LPAD(TRIM(xCOD_CALCULO_VALOR_CAT),2,0)||xEDIFICABILIDAD
					||LPAD(' ',147,' ')||xEXIS_INFOR_CARTAGRAFICA||vDESCRIP_ALTER_CATASTRAL||xTIPO_MOVIMIENTO
					||LPAD(TRIM(xYEAR_EXPEDIENTE),4,0)||RPAD(TRIM(xREF_EXPEDIENTE),13,' ')||LPAD(TRIM(xCOD_ENTIDAD_ORIGEN_EXPE),3,0)
					||xEXISTE_DECLARA_ALTERACION||RPAD(TRIM(xCOD_MOTIVO_MOVIMIENTO),4,' ')||TO_CHAR(xFECHA_MOVIMIENTO,'YYYYMMDD')
					||TO_CHAR(xHORA_MOVIMIENTO,'HH24MISS')||TO_CHAR(xFECHA_ALTERA_CATASTRAL,'YYYYMMDD')||LPAD(' ',105,' ');

		Inserta_Reg_Finca(xDelegacionMEH,xGerencia,xMunicipio,vRegFinca);


end;




--
-- Insertar desde Delphi un registro de Suelo de Alta
--
-- Registro 12
--
PROCEDURE Alta_Suelo_Nueva(
		xDelegacionMEH 					in  VARCHAR2,
		xGerencia 						in  VARCHAR2,
		xMUNICIPIO						IN VARCHAR2,
		xREF_CATASTRAL					IN VARCHAR2,
		xLONG_FACHADA					IN FLOAT,
		xTIPO_FACHADA					IN VARCHAR2,
		xSUPERFICIE_SUELO				IN FLOAT,
		xFONDO_SUELO					IN FLOAT,
		xCOD_VA_PUBLICA					IN VARCHAR2,
		xCOD_TRAMO_VIA					IN VARCHAR2,
		xCOD_TIPO_VALOR					IN VARCHAR2,
		xNUM_FACHADAS					IN VARCHAR2,
		xAPLICA_COEF_LONG_FACHADA		IN VARCHAR2,	
		xAPLICA_COEF_FORMA_IRREGU		IN VARCHAR2,
		xAPLICA_COEF_DESMONTE_EXCESIVO	IN VARCHAR2,
		xAPLICA_COEF_PROFUN_FIRME		IN VARCHAR2,
		xAPLICA_COEF_FONDO_EXCESIVO		IN VARCHAR2,
		xAPLICA_COEF_SUPERF_NO_MIN		IN VARCHAR2,
		xAPLICA_COEF_INEDIFICABILIDAD	IN VARCHAR2,
		xAPLICA_COEF_SUELO_PROTEC_PUB	IN VARCHAR2,
		xCOEF_CORRECTOR					IN VARCHAR2,
      	xAPLICA_COEF_DEPRECIACION		IN VARCHAR2,
		xCOEF_FINCA_CARGAS_SINGULARES	IN VARCHAR2,
		xAPLICA_COEF_SITU_ESPECIAL     	IN VARCHAR2,
		xAPLICA_COEF_USO_NO_LUCRATIVO	IN VARCHAR2,		
		xTIPO_MOVIMIENTO				IN VARCHAR2,
		xYEAR_EXPEDIENTE				IN VARCHAR2,
		xREF_EXPEDIENTE					IN VARCHAR2,
		xCOD_ENTIDAD_COLABORADORA		IN VARCHAR2,
		xF_ALTERACION_CATASTRAL			IN DATE)
as
vRegSuelo				varchar2(720);
xSumaTotalSuelo			FLOAT DEFAULT 0;
xNUM_ORDEN_SUBPARCELA	VARCHAR2(4);
xCuantos				integer default 0;
xYEAR_APROBACION		CHAR(4);
xAGUA					CHAR(1);
xELECTRICIDAD			CHAR(1);
xALUMBRADO				CHAR(1);
xDESMONTE				CHAR(1);
xPAVIMENTACION			CHAR(1);
xALCANTARILLADO			CHAR(1);
begin


		--	El Número de Orden del elemento de suelo es calculado
		SELECT COUNT(*) INTO xCuantos FROM IBI_SUELO_FURB 
		WHERE MUNICIPIO=xMUNICIPIO AND REF_CATASTRAL=xREF_CATASTRAL;		
		
		xNUM_ORDEN_SUBPARCELA:=LPAD(xCuantos+1,4,0);

		--Buscamos en el fichero de Ponencia de Valores los datos del grado de Urbanizacion y el año de la ponencia de valores
		SELECT YEAR_APROBACION,INDICADOR_GRADO_AGUA,INDICADOR_GRADO_ELECT,INDICADOR_GRADO_ALUMB,INDICADOR_GRADO_DESMON,
		INDICADOR_GRADO_PAVIM,INDICADOR_GRADO_ALCAN
		INTO xYEAR_APROBACION,xAGUA,xELECTRICIDAD,xALUMBRADO,xDESMONTE,xPAVIMENTACION,xALCANTARILLADO
		FROM IBI_PONUR_DGC
		WHERE MUNICIPIO=xMunicipio AND COD_VIA_PUBLICA=xCOD_VA_PUBLICA AND TRIM(COD_TRAMO)=xCOD_TRAMO_VIA;
		
		
		vRegSuelo:='12'||RPAD(xREF_CATASTRAL,14,' ')||xNUM_ORDEN_SUBPARCELA||LPAD(' ',38,' ')||LPAD(TRIM(xLONG_FACHADA),5,0)||RPAD(xTIPO_FACHADA,2,' ')||LPAD(TRIM(xSUPERFICIE_SUELO),7,0)
					||LPAD(TRIM(xFONDO_SUELO),3,0)||LPAD(TRIM(xCOD_VA_PUBLICA),5,0)||RPAD(TRIM(xCOD_TRAMO_VIA),3,' ')||xCOD_TIPO_VALOR||xNUM_FACHADAS||xAPLICA_COEF_LONG_FACHADA||xAPLICA_COEF_FORMA_IRREGU
					||xAPLICA_COEF_DESMONTE_EXCESIVO||xAPLICA_COEF_PROFUN_FIRME||xAPLICA_COEF_FONDO_EXCESIVO||xAPLICA_COEF_SUPERF_NO_MIN||xAPLICA_COEF_INEDIFICABILIDAD
					||xAPLICA_COEF_SUELO_PROTEC_PUB||LPAD(TRIM(xCOEF_CORRECTOR),3,0)||xAPLICA_COEF_DEPRECIACION||LPAD(' ',1,' ')||LPAD(TRIM(xCOEF_FINCA_CARGAS_SINGULARES),3,0)||xAPLICA_COEF_SITU_ESPECIAL
					||xAPLICA_COEF_USO_NO_LUCRATIVO||xAGUA||xELECTRICIDAD||xALUMBRADO||xDESMONTE||xPAVIMENTACION||xALCANTARILLADO||LPAD(' ',425,' ')
					||xTIPO_MOVIMIENTO||LPAD(TRIM(xYEAR_EXPEDIENTE),4,0)||RPAD(xREF_EXPEDIENTE,13,' ')||LPAD(TRIM(xCOD_ENTIDAD_COLABORADORA),3,0)||TO_CHAR(xF_ALTERACION_CATASTRAL,'YYYYMMDD')||LPAD(' ',157,' ');
									
		Inserta_Reg_Suelo(xDelegacionMEH,xGerencia,xMunicipio,vRegSuelo);
		
		--Sólo cuando en la posicion 84 esté grabado el valor 2 es cuando hay que sumar 
		--sino se grabará la superficie del solar en la tabla de IBI_FINCA_FURB manualmente
		SELECT SUM(SUPERFICIE_SUELO) INTO xSumaTotalSuelo FROM IBI_SUELO_FURB 
		WHERE MUNICIPIO=xMUNICIPIO AND REF_CATASTRAL=xREF_CATASTRAL AND COD_TIPO_VALOR='2';
		
		
		UPDATE IBI_FINCA_FURB SET 
					YEAR_PONENCIA=xYEAR_APROBACION,
					SUPERFICIE_SOLARES=DECODE(xSumaTotalSuelo,NULL,SUPERFICIE_SOLARES,LPAD(xSumaTotalSuelo,7,0))
		WHERE MUNICIPIO=xMUNICIPIO AND REF_CATASTRAL=xREF_CATASTRAL;
		
		
end;



--
-- Insertar desde Delphi un registro de Construcción de Alta
--
-- Registro 14
--
PROCEDURE Alta_Construccion_Nueva(
		xMUNICIPIO						IN VARCHAR2,
		xREF_CATASTRAL					IN VARCHAR2,
		xNUM_CARGO						IN VARCHAR2,
		xCOD_UNIDAD_CONSTRUCTIVA		IN VARCHAR2,
		xBLOQUE							IN VARCHAR2,
		xESCALERA						IN VARCHAR2,
		xPLANTA							IN VARCHAR2,
		xPUERTA							IN VARCHAR2,
		xCOD_DESTINO					IN VARCHAR2,
		xTIPO_REFORMA					IN VARCHAR2,
		xYEAR_REFORMA					IN VARCHAR2,
		xLOCAL_INTERIOR					IN VARCHAR2,
		xSUPERFICIE_TOTAL_LOCAL			IN FLOAT,
		xSUPERFICIE_PORCHES_TERR		IN FLOAT,
		xSUPERFICIE_LOCAL_OTRAS_PL		IN FLOAT,	
		xTIPOLOGIA_CONSTRUCTIVA			IN VARCHAR2,
		xCOD_USO						IN VARCHAR2,
		xCOD_CATEGORIA					IN VARCHAR2,
		xCOD_MODALIDAD_REPARTO			IN VARCHAR2,
		xCOD_TIPO_VALOR_APLICAR			IN VARCHAR2,
		xCOEF_CORRECTOR					IN VARCHAR2,
    	xAPLICA_COEFICIENTE  			IN VARCHAR2,
    	xPRINCIPAL						IN VARCHAR2)
as
vRegConstruccion 		varchar2(720);
xCuantos				integer default 0;
xNUM_CONSTRUCCION		varchar2(4);
xSumaSobreRasante		float default 0;
xSumaBajoRasante		float default 0;
xSumaConstruidaTotal	float default 0;

vBLOQUE						char(4);

xTIPO_MOVIMIENTO			char(1);
xYEAR_EXPEDIENTE			char(4);
xREF_EXPEDIENTE				char(13);
xCOD_ENTIDAD_COLABORADORA	char(3);
xF_ALTERACION_CATASTRAL		date;

xDelegacionMEH 				char(2);
xGerencia 					char(1);

begin


		if TRIM(xBLOQUE) is null then
			vBLOQUE:='    ';
		else
			vBLOQUE:=RPAD(TRIM(xBLOQUE),4,' ');
		end if;


		--	El Número de Orden del elemento de construccion es calculado
		SELECT COUNT(*) INTO xCuantos FROM IBI_CONSTRUCCION_FURB
		WHERE MUNICIPIO=xMUNICIPIO AND REF_CATASTRAL=xREF_CATASTRAL;		
		
		xNUM_CONSTRUCCION:=LPAD(xCuantos+1,4,0);

		
		--Para recoger los datos del Movimiento
		SELECT DELEGACION_MEH,GERENCIA,TIPO_MOVIMIENTO,YEAR_EXPEDIENTE,REF_EXPEDIENTE,COD_ENTIDAD_ORIGEN_EXPE,FECHA_ALTERA_CATASTRAL
		INTO xDelegacionMEH,xGerencia,xTIPO_MOVIMIENTO,xYEAR_EXPEDIENTE,xREF_EXPEDIENTE,xCOD_ENTIDAD_COLABORADORA,xF_ALTERACION_CATASTRAL
		FROM IBI_FINCA_FURB 
		WHERE MUNICIPIO=xMUNICIPIO AND REF_CATASTRAL=xREF_CATASTRAL;
		
		vRegConstruccion:='14'||RPAD(xREF_CATASTRAL,14,' ')||xNUM_CONSTRUCCION||LPAD(xNUM_CARGO,4,0)||RPAD(xCOD_UNIDAD_CONSTRUCTIVA,4,' ')
					||LPAD(' ',30,' ')||vBLOQUE||RPAD(xESCALERA,2,' ')||RPAD(xPLANTA,3,' ')||RPAD(xPUERTA,3,' ')
					||RPAD(xCOD_DESTINO,3,' ')||xTIPO_REFORMA||RPAD(xYEAR_REFORMA,4,' ')||xLOCAL_INTERIOR||LPAD(xSUPERFICIE_TOTAL_LOCAL,7,0)
					||LPAD(xSUPERFICIE_PORCHES_TERR,7,0)||LPAD(xSUPERFICIE_LOCAL_OTRAS_PL,7,0)					
					||RPAD(xTIPOLOGIA_CONSTRUCTIVA,5,' ')||xCOD_USO||xCOD_CATEGORIA||RPAD(xCOD_MODALIDAD_REPARTO,3,' ')
					||xCOD_TIPO_VALOR_APLICAR||LPAD(xCOEF_CORRECTOR,3,0)||xAPLICA_COEFICIENTE||LPAD(' ',419,' ')
					||xTIPO_MOVIMIENTO||LPAD(TRIM(xYEAR_EXPEDIENTE),4,0)||RPAD(xREF_EXPEDIENTE,13,' ')||LPAD(TRIM(xCOD_ENTIDAD_COLABORADORA),3,0)
					||TO_CHAR(xF_ALTERACION_CATASTRAL,'YYYYMMDD')||LPAD(' ',157,' ');
		
		Inserta_Reg_Construccion(xDelegacionMEH,xGerencia,xMunicipio,vRegConstruccion,xPrincipal);
		
		
		--Por un lado se calcula los locales sobre rasante 
		SELECT SUM(SUPERFICIE_TOTAL_LOCAL) INTO xSumaSobreRasante FROM IBI_CONSTRUCCION_FURB
		WHERE MUNICIPIO=xMUNICIPIO AND REF_CATASTRAL=xREF_CATASTRAL AND substr(PLANTA,1,1)<>'-';
		
		if xSumaSobreRasante is null then
			xSumaSobreRasante:=0;
		end if;
		
		--Por otro lado se calcula los locales bajo rasante 
		SELECT SUM(SUPERFICIE_TOTAL_LOCAL) INTO xSumaBajoRasante FROM IBI_CONSTRUCCION_FURB
		WHERE MUNICIPIO=xMUNICIPIO AND REF_CATASTRAL=xREF_CATASTRAL AND substr(PLANTA,1,1)='-';
		
		if xSumaBajoRasante is null then
			xSumaBajoRasante:=0;
		end if;
		
		xSumaConstruidaTotal:=xSumaBajoRasante+xSumaSobreRasante;
		
		--Se actualiza en la tabla del registro de finca los campos Superficie construida total, Superficie construida sobre rasante y 
		--Superficie construida bajo rasante
		UPDATE IBI_FINCA_FURB SET 
								SUPERFICIE_FINCAS=LPAD(xSumaConstruidaTotal,7,0),
								SUPERF_SOBRE_RASANTE=LPAD(xSumaSobreRasante,7,0),
								SUPERF_BAJO_RASANTE=LPAD(xSumaBajoRasante,7,0)
		WHERE MUNICIPIO=xMUNICIPIO AND REF_CATASTRAL=xREF_CATASTRAL;
		
end;




--
-- Insertar desde Delphi un registro de Unidad Constructiva de Alta
--
-- Registro 13
--
PROCEDURE Alta_Unidad_Constructiva_Nueva(		
		xMUNICIPIO						IN VARCHAR2,
		xREF_CATASTRAL					IN VARCHAR2,
		xCOD_UNIDAD_CONSTRUCTIVA		IN VARCHAR2,	
		xCOD_ENTIDAD_MENOR				IN VARCHAR2,
		xCOD_VIA_PUBLICA				IN VARCHAR2,
		xTIPO_VIA						IN VARCHAR2,
		xNOMBRE_VIA						IN VARCHAR2,
		xPRIMER_NUMERO					IN VARCHAR2,
		xPRIMERA_LETRA					IN VARCHAR2,
		xSEGUNDO_NUMERO					IN VARCHAR2,
		xSEGUNDA_LETRA					IN VARCHAR2,
		xKILOMETRO						IN VARCHAR2,
		xBLOQUE							IN VARCHAR2,
		xTEXTO_DIRECCION				IN VARCHAR2,
		xCODIGO_POSTAL					IN VARCHAR2,	
		xYEAR_CONSTRUCCION				IN VARCHAR2,
		xLONG_FACHADA					IN VARCHAR2,
		xUSO_AGRARIO_LOCALES_ASOC		IN VARCHAR2,	
		xCOD_VA_PUBLICA_PONENCIA		IN VARCHAR2,
		xCOD_TRAMO_VIA					IN VARCHAR2,	
		xNUM_FACHADAS					IN VARCHAR2,
		xAPLICA_COEF_LONG_FACHADA		IN VARCHAR2,
		xCOD_COEF_ESTADO_CONSERVA		IN VARCHAR2,	
    	xAPLICA_COEF_DEPRECIACION		IN VARCHAR2,
		xCOEF_CORRECTOR					IN VARCHAR2,
		xAPLICA_COEF_SITU_ESPECIAL   	IN VARCHAR2,
		xAPLICA_COEF_USO_NO_LUCRATIVO	IN VARCHAR2,		
		xEXACTITUD_YEAR_CONSTRUCCION	IN VARCHAR2)
as
vRegUnidad 					varchar2(720);
vCOD_ENTIDAD_MENOR			char(2);
vTipoVia					CHAR(5);
vPRIMERA_LETRA				char(1);
vSEGUNDO_NUMERO				char(4);
vSEGUNDA_LETRA				char(1);
vKILOMETRO					char(5);
vBLOQUE						char(4);
vTEXTO_DIRECCION			char(25);
xAGUA						CHAR(1);
xELECTRICIDAD				CHAR(1);
xALUMBRADO					CHAR(1);
xDESMONTE					CHAR(1);
xPAVIMENTACION				CHAR(1);
xALCANTARILLADO				CHAR(1);
xTIPO_MOVIMIENTO			char(1);
xYEAR_EXPEDIENTE			char(4);
xREF_EXPEDIENTE				char(13);
xCOD_ENTIDAD_COLABORADORA	char(3);
xF_ALTERACION_CATASTRAL		date;

xDelegacionMEH 				char(2);
xGerencia 					char(1);
begin



		if TRIM(xCOD_ENTIDAD_MENOR) is null then
			vCOD_ENTIDAD_MENOR:='  ';
		else
			vCOD_ENTIDAD_MENOR:=RPAD(TRIM(xCOD_ENTIDAD_MENOR),2,' ');
		end if;

		if TRIM(xTIPO_VIA) is null then
			vTipoVia:='     ';
		else
			vTipoVia:=RPAD(TRIM(xTIPO_VIA),5,' ');
		end if;
				
		if TRIM(xPRIMERA_LETRA) is null then
			vPRIMERA_LETRA:=' ';
		else
			vPRIMERA_LETRA:=xPRIMERA_LETRA;
		end if;
		
		if TRIM(xSEGUNDO_NUMERO) is null then
			vSEGUNDO_NUMERO:='0000';
		else
			vSEGUNDO_NUMERO:=LPAD(TRIM(xSEGUNDO_NUMERO),4,0);
		end if;
		
		if TRIM(xSEGUNDA_LETRA) is null then
			vSEGUNDA_LETRA:=' ';
		else
			vSEGUNDA_LETRA:=xSEGUNDA_LETRA;
		end if;

		if TRIM(xKILOMETRO) is null then
			vKILOMETRO:='00000';
		else
			vKILOMETRO:=LPAD(TRIM(xKILOMETRO),5,0);
		end if;
		
		if TRIM(xBLOQUE) is null then
			vBLOQUE:='    ';
		else
			vBLOQUE:=RPAD(TRIM(xBLOQUE),4,' ');
		end if;
		
		if TRIM(xTEXTO_DIRECCION) is null then
			vTEXTO_DIRECCION:=LPAD(' ',25,' ');  
		else
			vTEXTO_DIRECCION:=RPAD(TRIM(xTEXTO_DIRECCION),25,' ');
		end if;
		
		
		--Buscamos en el fichero de Ponencia de Valores los datos del grado de Urbanizacion
		SELECT INDICADOR_GRADO_AGUA,INDICADOR_GRADO_ELECT,INDICADOR_GRADO_ALUMB,INDICADOR_GRADO_DESMON,
		INDICADOR_GRADO_PAVIM,INDICADOR_GRADO_ALCAN
		INTO xAGUA,xELECTRICIDAD,xALUMBRADO,xDESMONTE,xPAVIMENTACION,xALCANTARILLADO
		FROM IBI_PONUR_DGC
		WHERE MUNICIPIO=xMunicipio AND COD_VIA_PUBLICA=xCOD_VA_PUBLICA_PONENCIA AND TRIM(COD_TRAMO)=xCOD_TRAMO_VIA;

		
		--Para recoger los datos del Movimiento
		SELECT DELEGACION_MEH,GERENCIA,TIPO_MOVIMIENTO,YEAR_EXPEDIENTE,REF_EXPEDIENTE,COD_ENTIDAD_ORIGEN_EXPE,FECHA_ALTERA_CATASTRAL
		INTO xDelegacionMEH,xGerencia,xTIPO_MOVIMIENTO,xYEAR_EXPEDIENTE,xREF_EXPEDIENTE,xCOD_ENTIDAD_COLABORADORA,xF_ALTERACION_CATASTRAL
		FROM IBI_FINCA_FURB 
		WHERE MUNICIPIO=xMUNICIPIO AND REF_CATASTRAL=xREF_CATASTRAL;
		

		vRegUnidad:='13'||RPAD(xREF_CATASTRAL,14,' ')||xCOD_UNIDAD_CONSTRUCTIVA||LPAD(' ',38,' ')
				||vCOD_ENTIDAD_MENOR||LPAD(TRIM(xCOD_VIA_PUBLICA),5,0)||vTipoVia||RPAD(xNOMBRE_VIA,25,' ')
				||LPAD(TRIM(xPRIMER_NUMERO),4,0)||vPRIMERA_LETRA||vSEGUNDO_NUMERO||vSEGUNDA_LETRA||vKILOMETRO||vBLOQUE||vTEXTO_DIRECCION
				||LPAD(TRIM(xCODIGO_POSTAL),5,0)
				||xYEAR_CONSTRUCCION||LPAD(TRIM(xLONG_FACHADA),5,0)||xUSO_AGRARIO_LOCALES_ASOC
				||LPAD(TRIM(xCOD_VA_PUBLICA_PONENCIA),5,0)||RPAD(TRIM(xCOD_TRAMO_VIA),3,' ')||xNUM_FACHADAS||xAPLICA_COEF_LONG_FACHADA
				||xCOD_COEF_ESTADO_CONSERVA||xAPLICA_COEF_DEPRECIACION||LPAD(TRIM(xCOEF_CORRECTOR),3,0)
				||xAPLICA_COEF_SITU_ESPECIAL||xAPLICA_COEF_USO_NO_LUCRATIVO
				||xAGUA||xELECTRICIDAD||xALUMBRADO||xDESMONTE||xPAVIMENTACION||xALCANTARILLADO||xEXACTITUD_YEAR_CONSTRUCCION
				||LPAD(' ',356,' ')
				||xTIPO_MOVIMIENTO||LPAD(TRIM(xYEAR_EXPEDIENTE),4,0)||RPAD(xREF_EXPEDIENTE,13,' ')||LPAD(TRIM(xCOD_ENTIDAD_COLABORADORA),3,0)
				||TO_CHAR(xF_ALTERACION_CATASTRAL,'YYYYMMDD')||LPAD(' ',157,' ');
		
		Inserta_Reg_Unidad_Construc(xDelegacionMEH,xGerencia,xMunicipio,vRegUnidad);


end;


--
-- Registro 15
--
PROCEDURE Alta_Registro_Cargo_Nueva(		
		xMUNICIPIO						IN VARCHAR2,
		xREF_CATASTRAL					IN VARCHAR2,		
		xCOEF_PARTICIPACION				IN VARCHAR2,		
		xNIF							IN VARCHAR2,
		xPERSONALIDAD					IN VARCHAR2,
		xNOMBRE							IN VARCHAR2,
		xNUM_COMPONENTES				IN VARCHAR2,
		xCOMPLEMENTO_NOMBRE				IN VARCHAR2,
		xCOD_DEL_MEH					IN VARCHAR2,
		xCOD_MUNICIPIO_DGC				IN VARCHAR2,
		xCOD_PROVI_INE_FISCAL			IN VARCHAR2,
		xCOD_MUNI_INE_FISCAL			IN VARCHAR2,
		xCOD_VIA_PUBLICA_FISCAL			IN VARCHAR2,
		xTIPO_VIA_FISCAL				IN VARCHAR2,
		xNOMBRE_VIA_FISCAL				IN VARCHAR2,
		xPRIMER_NUMERO_FISCAL			IN VARCHAR2,
		xPRIMERA_LETRA_FISCAL			IN VARCHAR2,
		xSEGUNDO_NUMERO_FISCAL			IN VARCHAR2,
		xSEGUNDA_LETRA_FISCAL			IN VARCHAR2,
		xKILOMETRO_FISCAL				IN VARCHAR2,
		xBLOQUE_FISCAL					IN VARCHAR2,
		xTEXTO_DIRECCION_FISCAL			IN VARCHAR2,
		xESCALERA_FISCAL				IN VARCHAR2,
		xPLANTA_FISCAL					IN VARCHAR2,
		xPUERTA_FISCAL					IN VARCHAR2,
		xCOD_POSTAL_FISCAL				IN VARCHAR2,
		xAPARTADO_CORREOS				IN VARCHAR2,
		xPAIS							IN VARCHAR2,
		xPROVINCIA						IN VARCHAR2,
		xMUNICIPIO_FISCAL				IN VARCHAR2,
		xYEAR_VALOR_CATASTRAL			IN VARCHAR2,
		xVALOR_CATASTRAL				IN FLOAT,
		xVALOR_SUELO					IN FLOAT,
		xVALOR_CONSTRUCCION				IN FLOAT,
		xBASE_LIQUIDABLE				IN FLOAT,
		xCLAVE_USO						IN VARCHAR2,
		xYEAR_ULTIMA_REVISION			IN VARCHAR2,
		xYEAR_ULTIMA_NOTIFICACION		IN VARCHAR2,
		xNUM_ULTIMA_NOTI				IN VARCHAR2,
		xSUPERF_ELEM_CONSTRUCTIVOS		IN FLOAT,
		xSUPERFICIE_ELEM_SUELO			IN FLOAT,
		xCOEFICIENTE_FINCA				IN VARCHAR2,
		xAPLICA_PRECIO_MAX_ADMIN		IN VARCHAR2,
		xYEAR_FIN_PRECIO_MAX_ADMIN		IN VARCHAR2,
		xTIPO_PROPIEDAD_CARGO			IN VARCHAR2,		
		xEJERCICIO_ENTRADA_PADRON		IN VARCHAR2,		
		xIDReg14						IN INTEGER)
as
vRegCargo 					varchar2(720);
xCuantos					integer default 0;

xNUM_CARGO					varchar2(4);

--Cuando son altas no se sabe los digitos de control y el número fijo, esto vendrá informado posteriormente por el catastro
vPRIMER_CARACTER_CONTROL	char(1) default ' ';
vSEGUN_CARACTER_CONTROL		char(1) default ' ';
vNUM_FIJO					char(8) default LPAD(' ',8,' ');
vCARACTER_CONTROL_N_FIJO	char(1) default ' ';
vCOEF_PARTICIPACION			char(5);

--domicilio tributario
xDISTRITO_CENSAL			char(2);
xCOD_ENTIDAD_MENOR			char(2);
xCOD_VIA_PUBLICA			char(5);
xTIPO_VIA					char(5);
xNOMBRE_VIA					char(25);
xPRIMER_NUMERO				char(4);
xPRIMERA_LETRA				char(1);
xSEGUNDO_NUMERO				char(4);
xSEGUNDA_LETRA				char(1);
xKILOMETRO					char(5);
xBLOQUE						char(4);
xTEXTO_DIRECCION			char(25);
xCODIGO_POSTAL				char(5);
xESCALERA					char(2);
xPLANTA						char(3);
xPUERTA						char(3);

vNUM_COMPONENTES			char(4);
vCOMPLEMENTO_NOMBRE			char(20);
vPRIMERA_LETRA_FISCAL		char(1);
vSEGUNDO_NUMERO_FISCAL		char(4);
vSEGUNDA_LETRA_FISCAL		char(1);
vKILOMETRO_FISCAL			char(5);
vBLOQUE_FISCAL				char(4);
vTEXTO_DIRECCION_FISCAL		char(25);
vESCALERA_FISCAL			char(2);
vPLANTA_FISCAL				char(3);
vPUERTA_FISCAL				char(3);
vCOD_POSTAL_FISCAL			char(5);
vAPARTADO_CORREOS			char(5);
vYEAR_ULTIMA_REVISION		char(4);
vYEAR_ULTIMA_NOTIFICACION	char(4);
vNUM_ULTIMA_NOTI			char(6);
vSUPERF_ELEM_CONSTRUCTIVOS	char(7);
vSUPERFICIE_ELEM_SUELO		char(7);
vCOEFICIENTE_FINCA			char(7);
vYEAR_FIN_PRECIO_MAX_ADMIN	char(4);
xTIPO_MOVIMIENTO			char(1);
xYEAR_EXPEDIENTE			char(4);
xREF_EXPEDIENTE				char(13);
xCOD_ENTIDAD_COLABORADORA	char(3);
xF_ALTERACION_CATASTRAL		date;

xDelegacionMEH 				char(2);
xGerencia 					char(1);
xCOD_CALCULO				CHAR(2);
begin		
		
		if RTRIM(xCOEF_PARTICIPACION) is null then
			vCOEF_PARTICIPACION:='00000';
		else
			vCOEF_PARTICIPACION:=LPAD(RTRIM(xCOEF_PARTICIPACION),5,0);
		end if;		
		
		if TRIM(xNUM_COMPONENTES) is null then
			vNUM_COMPONENTES:='0000';
		else
			vNUM_COMPONENTES:=LPAD(TRIM(xNUM_COMPONENTES),4,0);		
		end if;
		
		if TRIM(xCOMPLEMENTO_NOMBRE) is null then
			vCOMPLEMENTO_NOMBRE:=RPAD(' ',20,' ');
		else
			vCOMPLEMENTO_NOMBRE:=RPAD(xCOMPLEMENTO_NOMBRE,20,' ');
		end if;
		
		if TRIM(xPRIMERA_LETRA_FISCAL) is null then
			vPRIMERA_LETRA_FISCAL:=' ';
		else
			vPRIMERA_LETRA_FISCAL:=xPRIMERA_LETRA_FISCAL;
		end if;
		
		if TRIM(xSEGUNDO_NUMERO_FISCAL) is null then
			vSEGUNDO_NUMERO_FISCAL:='0000';
		else
			vSEGUNDO_NUMERO_FISCAL:=LPAD(TRIM(xSEGUNDO_NUMERO_FISCAL),4,0);
		end if;
		
		if TRIM(xSEGUNDA_LETRA_FISCAL) is null then
			vSEGUNDA_LETRA_FISCAL:=' ';
		else
			vSEGUNDA_LETRA_FISCAL:=xSEGUNDA_LETRA_FISCAL;
		end if;
		
		if TRIM(xKILOMETRO_FISCAL) is null then
			vKILOMETRO_FISCAL:='00000';
		else
			vKILOMETRO_FISCAL:=LPAD(TRIM(xKILOMETRO_FISCAL),5,0);
		end if;
		
		if TRIM(xBLOQUE_FISCAL) is null then
			vBLOQUE_FISCAL:='    ';
		else
			vBLOQUE_FISCAL:=RPAD(TRIM(xBLOQUE_FISCAL),4,' ');		
		end if;
		
		if TRIM(xTEXTO_DIRECCION_FISCAL) is null then
			vTEXTO_DIRECCION_FISCAL:=RPAD(' ',25,' ');
		else
			vTEXTO_DIRECCION_FISCAL:=RPAD(TRIM(xTEXTO_DIRECCION_FISCAL),25,' ');
		end if;
		
		if TRIM(xESCALERA_FISCAL) is null then
			vESCALERA_FISCAL:='  ';
		else
			vESCALERA_FISCAL:=RPAD(TRIM(xESCALERA_FISCAL),2,' ');
		end if;
		
		if TRIM(xPLANTA_FISCAL) is null then
			vPLANTA_FISCAL:='   ';
		else
			vPLANTA_FISCAL:=RPAD(TRIM(xPLANTA_FISCAL),3,' ');
		end if;
		
		if TRIM(xPUERTA_FISCAL) is null then
			vPUERTA_FISCAL:='   ';
		else
			vPUERTA_FISCAL:=RPAD(TRIM(xPUERTA_FISCAL),3,' ');
		end if;
		
		if TRIM(xCOD_POSTAL_FISCAL) is null then
			vCOD_POSTAL_FISCAL:='     ';
		else
			vCOD_POSTAL_FISCAL:=LPAD(TRIM(xCOD_POSTAL_FISCAL),5,0);
		end if;
		
		if TRIM(xAPARTADO_CORREOS) is null then
			vAPARTADO_CORREOS:='     ';
		else
			vAPARTADO_CORREOS:=LPAD(TRIM(xAPARTADO_CORREOS),5,0);
		end if;
				
		if TRIM(xYEAR_ULTIMA_REVISION) is null then
			vYEAR_ULTIMA_REVISION:='0000';
		else
			vYEAR_ULTIMA_REVISION:=xYEAR_ULTIMA_REVISION;
		end if;
		
		if TRIM(xYEAR_ULTIMA_NOTIFICACION) is null then
			vYEAR_ULTIMA_NOTIFICACION:='0000';
		else
			vYEAR_ULTIMA_NOTIFICACION:=xYEAR_ULTIMA_NOTIFICACION;
		end if;
		
		if TRIM(xNUM_ULTIMA_NOTI) is null then
			vNUM_ULTIMA_NOTI:='000000';
		else
			vNUM_ULTIMA_NOTI:=LPAD(TRIM(xNUM_ULTIMA_NOTI),6,0);
		end if;
		
		if TRIM(xSUPERF_ELEM_CONSTRUCTIVOS) is null then
			vSUPERF_ELEM_CONSTRUCTIVOS:='0000000';
		else
			vSUPERF_ELEM_CONSTRUCTIVOS:=LPAD(TRIM(xSUPERF_ELEM_CONSTRUCTIVOS),7,0);
		end if;
		
		if TRIM(xSUPERFICIE_ELEM_SUELO) is null then
			vSUPERFICIE_ELEM_SUELO:='0000000';
		else
			vSUPERFICIE_ELEM_SUELO:=LPAD(TRIM(xSUPERFICIE_ELEM_SUELO),7,0);		
		end if;
		
		if TRIM(xCOEFICIENTE_FINCA) is null then
			vCOEFICIENTE_FINCA:='0000000';
		else
			vCOEFICIENTE_FINCA:=LPAD(TRIM(xCOEFICIENTE_FINCA),7,0);			
		end if;
		
		if TRIM(xYEAR_FIN_PRECIO_MAX_ADMIN) is null then
			vYEAR_FIN_PRECIO_MAX_ADMIN:='0000';
		else
			vYEAR_FIN_PRECIO_MAX_ADMIN:=xYEAR_FIN_PRECIO_MAX_ADMIN;
		end if;
		
		
		--Para recoger los datos del Movimiento
		SELECT DELEGACION_MEH,GERENCIA,TIPO_MOVIMIENTO,YEAR_EXPEDIENTE,REF_EXPEDIENTE,COD_ENTIDAD_ORIGEN_EXPE,FECHA_ALTERA_CATASTRAL,		
		DISTRITO_CENSAL,COD_ENTIDAD_MENOR,COD_VIA_PUBLICA,TIPO_VIA,NOMBRE_VIA,PRIMER_NUMERO,PRIMERA_LETRA,SEGUNDO_NUMERO,
		SEGUNDA_LETRA,KILOMETRO,BLOQUE,TEXTO_DIRECCION,CODIGO_POSTAL,COD_CALCULO_VALOR_CAT
		INTO xDelegacionMEH,xGerencia,xTIPO_MOVIMIENTO,xYEAR_EXPEDIENTE,xREF_EXPEDIENTE,xCOD_ENTIDAD_COLABORADORA,xF_ALTERACION_CATASTRAL,
		xDISTRITO_CENSAL,xCOD_ENTIDAD_MENOR,xCOD_VIA_PUBLICA,xTIPO_VIA,xNOMBRE_VIA,xPRIMER_NUMERO,xPRIMERA_LETRA,xSEGUNDO_NUMERO,xSEGUNDA_LETRA,
		xKILOMETRO,xBLOQUE,xTEXTO_DIRECCION,xCODIGO_POSTAL,xCOD_CALCULO
		FROM IBI_FINCA_FURB 
		WHERE MUNICIPIO=xMUNICIPIO AND REF_CATASTRAL=xREF_CATASTRAL;
		
		--Código de la forma de cálculo:
		--11: Solar con uno o más propietarios: se graba fijo las letras SUELO
		--El domicilio tributario es el del registro de finca
		if xCOD_CALCULO='11' then
		
			xESCALERA:='S';
			xPLANTA:='UE';
			xPUERTA:='LO';
			
		end if;
		
		--Código de la forma de cálculo:
		--31,32,34,35: Terreno con construcción de un solo propietario
		--El domicilio tributario es el del registro de unidad constructiva
		if xCOD_CALCULO in ('31','32','34','35') then
			
			SELECT COD_ENTIDAD_MENOR,COD_VIA_PUBLICA,TIPO_VIA,NOMBRE_VIA,PRIMER_NUMERO,PRIMERA_LETRA,SEGUNDO_NUMERO,
			SEGUNDA_LETRA,KILOMETRO,BLOQUE,TEXTO_DIRECCION,CODIGO_POSTAL
			INTO xCOD_ENTIDAD_MENOR,xCOD_VIA_PUBLICA,xTIPO_VIA,xNOMBRE_VIA,xPRIMER_NUMERO,xPRIMERA_LETRA,xSEGUNDO_NUMERO,xSEGUNDA_LETRA,
			xKILOMETRO,xBLOQUE,xTEXTO_DIRECCION,xCODIGO_POSTAL
			FROM IBI_CONSTRUCTIVA_FURB
			WHERE MUNICIPIO=xMUNICIPIO AND REF_CATASTRAL=xREF_CATASTRAL;
		
			xESCALERA:='T';
			xPLANTA:='OD';
			xPUERTA:='OS';
		
		end if;
		
		--Código de la forma de cálculo:
		--41,42,44: Terreno con construcción de varios propietarios
		--51,52,54: Terreno con construcción de varios propietarios o de uno pero el suelo y la construcción son propietarios independientes
		--61,62,64: Terreno con construcción de varios propietarios y el derecho de vuelo no materializado es de otro propietario
		--El domicilio tributario es el del registro de unidad constructiva, menos escalera,planta y puerta que se recogen del registro
		-- de construcción declarado como principal
		if xCOD_CALCULO in ('41','42','44','51','52','54','61','62','64') then
			
			SELECT COD_ENTIDAD_MENOR,COD_VIA_PUBLICA,TIPO_VIA,NOMBRE_VIA,PRIMER_NUMERO,PRIMERA_LETRA,SEGUNDO_NUMERO,
			SEGUNDA_LETRA,KILOMETRO,BLOQUE,TEXTO_DIRECCION,CODIGO_POSTAL
			INTO xCOD_ENTIDAD_MENOR,xCOD_VIA_PUBLICA,xTIPO_VIA,xNOMBRE_VIA,xPRIMER_NUMERO,xPRIMERA_LETRA,xSEGUNDO_NUMERO,xSEGUNDA_LETRA,
			xKILOMETRO,xBLOQUE,xTEXTO_DIRECCION,xCODIGO_POSTAL
			FROM IBI_CONSTRUCTIVA_FURB
			WHERE MUNICIPIO=xMUNICIPIO AND REF_CATASTRAL=xREF_CATASTRAL;
		
			
			SELECT ESCALERA,PLANTA,PUERTA INTO xESCALERA,xPLANTA,xPUERTA FROM IBI_CONSTRUCCION_FURB
			WHERE MUNICIPIO=xMUNICIPIO AND REF_CATASTRAL=xREF_CATASTRAL AND PRINCIPAL='S';
		
		end if;
		
		
		--	El Número de Cargo es calculado de forma secuencial
		SELECT COUNT(*) INTO xCuantos FROM IBI_CARGO_FURB
		WHERE MUNICIPIO=xMUNICIPIO AND REF_CATASTRAL=xREF_CATASTRAL;		
		
		xNUM_CARGO:=LPAD(xCuantos+1,4,0);


		vRegCargo:='15'||RPAD(xREF_CATASTRAL,14,' ')||xNUM_CARGO
					||vPRIMER_CARACTER_CONTROL||vSEGUN_CARACTER_CONTROL||vNUM_FIJO||vCARACTER_CONTROL_N_FIJO
					||vCOEF_PARTICIPACION||LPAD(' ',20,' ')||xDISTRITO_CENSAL
					||xCOD_ENTIDAD_MENOR||LPAD(TRIM(xCOD_VIA_PUBLICA),5,0)||RPAD(xTIPO_VIA,5,' ')||RPAD(xNOMBRE_VIA,25,' ')
					||LPAD(TRIM(xPRIMER_NUMERO),4,0)||xPRIMERA_LETRA||xSEGUNDO_NUMERO||xSEGUNDA_LETRA||xKILOMETRO||xBLOQUE||xTEXTO_DIRECCION
					||LPAD(TRIM(xCODIGO_POSTAL),5,0)||xESCALERA||xPLANTA||xPUERTA
					||RPAD(SUBSTR(xNIF,1,8),8,' ')||SUBSTR(xNIF,9,1)
					||xPERSONALIDAD||RPAD(xNOMBRE,60,' ')||vNUM_COMPONENTES||vCOMPLEMENTO_NOMBRE
					||xCOD_DEL_MEH||xCOD_MUNICIPIO_DGC||xCOD_PROVI_INE_FISCAL||xCOD_MUNI_INE_FISCAL||xCOD_VIA_PUBLICA_FISCAL
					||RPAD(TRIM(xTIPO_VIA_FISCAL),5,' ')||RPAD(TRIM(xNOMBRE_VIA_FISCAL),25,' ')||xPRIMER_NUMERO_FISCAL||vPRIMERA_LETRA_FISCAL
					||vSEGUNDO_NUMERO_FISCAL||vSEGUNDA_LETRA_FISCAL||vKILOMETRO_FISCAL||vBLOQUE_FISCAL||vTEXTO_DIRECCION_FISCAL||vESCALERA_FISCAL
					||vPLANTA_FISCAL||vPUERTA_FISCAL||vCOD_POSTAL_FISCAL||vAPARTADO_CORREOS
					||RPAD(TRIM(xPAIS),25,' ')||RPAD(TRIM(xPROVINCIA),25,' ')||RPAD(TRIM(xMUNICIPIO_FISCAL),25,' ')					
					||xYEAR_VALOR_CATASTRAL||LPAD(RTRIM(xVALOR_CATASTRAL*100),12,0)||LPAD(TRIM(xVALOR_SUELO*100),12,0)
					||LPAD(TRIM(xVALOR_CONSTRUCCION*100),12,0)||LPAD(TRIM(xBASE_LIQUIDABLE*100),12,0)||xCLAVE_USO
					||vYEAR_ULTIMA_REVISION||vYEAR_ULTIMA_NOTIFICACION||vNUM_ULTIMA_NOTI||vSUPERF_ELEM_CONSTRUCTIVOS||vSUPERFICIE_ELEM_SUELO
					||vCOEFICIENTE_FINCA||xAPLICA_PRECIO_MAX_ADMIN||vYEAR_FIN_PRECIO_MAX_ADMIN||xTIPO_PROPIEDAD_CARGO||LPAD(' ',12,' ')
					||xTIPO_MOVIMIENTO||LPAD(TRIM(xYEAR_EXPEDIENTE),4,0)||RPAD(xREF_EXPEDIENTE,13,' ')||xEJERCICIO_ENTRADA_PADRON
					||LPAD(TRIM(xCOD_ENTIDAD_COLABORADORA),3,0)||TO_CHAR(xF_ALTERACION_CATASTRAL,'YYYYMMDD')||LPAD(' ',153,' ');
		
		Inserta_Reg_Unidad_Cargo(xDelegacionMEH,xGerencia,xMunicipio,vRegCargo);
		
		
		UPDATE IBI_CONSTRUCCION_FURB SET NUM_CARGO=xNUM_CARGO WHERE ID=xIDReg14;

end;


--
--
-- Eliminar un registro de suelo manualmente desde Delphi. Hay que recalcular los metros del solar y actualizar en la tabla de Finca
--
PROCEDURE Del_Registro_Suelo(
						xID					IN INTEGER,
						xMUNICIPIO			IN VARCHAR2,
						xREF_CATASTRAL		IN VARCHAR2)
as
xSumaTotalSuelo		FLOAT DEFAULT 0;
begin


	DELETE FROM IBI_SUELO_FURB WHERE ID=xID;

	
	SELECT SUM(SUPERFICIE_SUELO) INTO xSumaTotalSuelo FROM IBI_SUELO_FURB WHERE MUNICIPIO=xMUNICIPIO AND REF_CATASTRAL=xREF_CATASTRAL;
		
	IF xSumaTotalSuelo IS NOT NULL THEN		
		UPDATE IBI_FINCA_FURB SET SUPERFICIE_SOLARES=xSumaTotalSuelo WHERE MUNICIPIO=xMUNICIPIO AND REF_CATASTRAL=xREF_CATASTRAL;
	END IF;

end;

--
--
--
--
PROCEDURE Inserta_Reg_Finca(xDelegacionMEH in char,xGerencia in char,xAyto in char,vRegFinca in varchar2)
as
	vFECHA_MOVIMIENTO		DATE;
	
	vFECHA_ALTERA_CATASTRAL	DATE;
	
	vIMPORTE_INGRESADO		FLOAT;
	vFECHA_INGRESO			DATE;
begin



	IF RTRIM(SubStr(vRegFinca,596,7)) IS NULL THEN
		vIMPORTE_INGRESADO:=0;
	ELSE
		vIMPORTE_INGRESADO:=TO_NUMBER(SubStr(vRegFinca,596,7))/100;
	END IF;
			    
	IF SubStr(vRegFinca,561,8)='00000000' THEN
		vFECHA_MOVIMIENTO:=NULL;
	ELSE 
		vFECHA_MOVIMIENTO:=TO_DATE(SubStr(vRegFinca,561,8),'YYYYMMDD');
	END IF;
				
	IF SubStr(vRegFinca,575,8)='00000000' THEN
		vFECHA_ALTERA_CATASTRAL:=NULL;
	ELSE 
		vFECHA_ALTERA_CATASTRAL:=TO_DATE(SubStr(vRegFinca,575,8),'YYYYMMDD');
	END IF;
				
	IF (SubStr(vRegFinca,603,8)='00000000') or (rtrim(SubStr(vRegFinca,603,8)) is null) THEN
		vFECHA_INGRESO:=NULL;
	ELSE 
		vFECHA_INGRESO:=TO_DATE(SubStr(vRegFinca,603,8),'YYYYMMDD');
	END IF;
		
					
	INSERT INTO IBI_FINCA_FURB(	
			DELEGACION_MEH,GERENCIA,MUNICIPIO,REF_CATASTRAL,DISTRITO_CENSAL,
			--DOMICILIO TRIBUTARIO
			COD_ENTIDAD_MENOR,COD_VIA_PUBLICA,TIPO_VIA,NOMBRE_VIA,PRIMER_NUMERO,PRIMERA_LETRA,SEGUNDO_NUMERO,
			SEGUNDA_LETRA,KILOMETRO,BLOQUE,TEXTO_DIRECCION,CODIGO_POSTAL,
			--DATOS FISICOS
			SUPERFICIE_SOLARES,SUPERFICIE_FINCAS,SUPERF_SOBRE_RASANTE,SUPERF_BAJO_RASANTE,SUPERF_CUBIERTA,	
			--DATOS DE VALORACION
			YEAR_PONENCIA,COD_CALCULO_VALOR_CAT,EDIFICABILIDAD,
			--Datos de la Alteracion
			EXIS_INFOR_CARTAGRAFICA,DESCRIP_ALTER_CATASTRAL,	
			--DATOS DEL MOVIMIENTO
			TIPO_MOVIMIENTO,YEAR_EXPEDIENTE,REF_EXPEDIENTE,COD_ENTIDAD_ORIGEN_EXPE,EXISTE_DECLARA_ALTERACION,
			COD_MOTIVO_MOVIMIENTO,FECHA_MOVIMIENTO,HORA_MOVIMIENTO,FECHA_ALTERA_CATASTRAL,
			--DATOS DE LA TASA DE INSCRIPCIÓN CATASTRAL
			NUM_IMPRESO_AUTOLIQUI,IMPORTE_INGRESADO,FECHA_INGRESO,COD_ENTIDAD,
			COD_SUCURSAL,NIF_TITULAR_INGRESO,NOMBRE_TITULAR_INGRESO)
	VALUES (
			xDelegacionMEH,xGerencia,xAyto,SubStr(vRegFinca,3,14),SubStr(vRegFinca,57,2),
			--DOMICILIO TRIBUTARIO
			SubStr(vRegFinca,59,2),SubStr(vRegFinca,61,5),SubStr(vRegFinca,66,5),SubStr(vRegFinca,71,25),SubStr(vRegFinca,96,4),SubStr(vRegFinca,100,1),
			SubStr(vRegFinca,101,4),SubStr(vRegFinca,105,1),SubStr(vRegFinca,106,5),SubStr(vRegFinca,111,4),SubStr(vRegFinca,115,25),SubStr(vRegFinca,140,5),
			--DATOS FISICOS
			SubStr(vRegFinca,145,7),SubStr(vRegFinca,152,7),SubStr(vRegFinca,159,7),SubStr(vRegFinca,166,7),SubStr(vRegFinca,173,7),
			--DATOS DE VALORACION
			SubStr(vRegFinca,180,4),SubStr(vRegFinca,184,2),SubStr(vRegFinca,186,1),
			--Datos de la Alteracion
			SubStr(vRegFinca,334,1),SubStr(vRegFinca,335,200),
			--DATOS DEL MOVIMIENTO
			SubStr(vRegFinca,535,1),SubStr(vRegFinca,536,4),SubStr(vRegFinca,540,13),SubStr(vRegFinca,553,3),SubStr(vRegFinca,556,1),SubStr(vRegFinca,557,4),
			vFECHA_MOVIMIENTO,SubStr(vRegFinca,569,6),vFECHA_ALTERA_CATASTRAL,
			--DATOS DE LA TASA DE INSCRIPCIÓN CATASTRAL
			SubStr(vRegFinca,583,13),vIMPORTE_INGRESADO,vFECHA_INGRESO,SubStr(vRegFinca,611,4),SubStr(vRegFinca,615,4),SubStr(vRegFinca,619,9),
			SubStr(vRegFinca,628,60)
	);


end;


PROCEDURE Inserta_Reg_Suelo(xDelegacionMEH in char, xGerencia in char, xAyto in char,vRegFinca in varchar2)
as
	vF_ALTERACION_CATASTRAL	DATE;
	vLONG_FACHADA			FLOAT;
	vSUPERFICIE_SUELO		FLOAT;
	vFONDO_SUELO			FLOAT;
begin


	if TRIM(SubStr(vRegFinca,59,5)) is null then	
		vLONG_FACHADA:=0;
	else
		vLONG_FACHADA:=TO_NUMBER(TRIM(SubStr(vRegFinca,59,5)));
	end if;
	
	if TRIM(SubStr(vRegFinca,66,7)) is null then
		vSUPERFICIE_SUELO:=0;
	else
		vSUPERFICIE_SUELO:=TO_NUMBER(TRIM(SubStr(vRegFinca,66,7)));
	end if;
	
	if TRIM(SubStr(vRegFinca,73,3)) is null then
		vFONDO_SUELO:=0;
	else
		vFONDO_SUELO:=TO_NUMBER(TRIM(SubStr(vRegFinca,73,3)));
	end if;

	IF SubStr(vRegFinca,556,8)='00000000' or TRIM(SubStr(vRegFinca,556,8)) is null THEN
		vF_ALTERACION_CATASTRAL:=NULL;
	ELSE 
		vF_ALTERACION_CATASTRAL:=TO_DATE(SubStr(vRegFinca,556,8),'YYYYMMDD');
	END IF;

	insert into IBI_SUELO_FURB(DELEGACION_MEH,GERENCIA,MUNICIPIO,REF_CATASTRAL,NUM_ORDEN_SUBPARCELA,
			--DATOS FISICOS
			LONG_FACHADA,TIPO_FACHADA,SUPERFICIE_SUELO,FONDO_SUELO,
			--DATOS DE VALORACION
			COD_VA_PUBLICA,COD_TRAMO_VIA,COD_TIPO_VALOR,			
			NUM_FACHADAS,APLICA_COEF_LONG_FACHADA,APLICA_COEF_FORMA_IRREGU,APLICA_COEF_DESMONTE_EXCESIVO,APLICA_COEF_PROFUN_FIRME,
			APLICA_COEF_FONDO_EXCESIVO,APLICA_COEF_SUPERF_NO_MIN,APLICA_COEF_INEDIFICABILIDAD,APLICA_COEF_SUELO_PROTEC_PUB,			
			COEF_CORRECTOR,APLICA_COEF_DEPRECIACION,COEF_FINCA_CARGAS_SINGULARES,APLICA_COEF_SITU_ESPECIAL,APLICA_COEF_USO_NO_LUCRATIVO,			
			AGUA,ELECTRICIDAD,ALUMBRADO,DESMONTE,PAVIMENTACION,ALCANTARILLADO,
			--DATOS DEL MOVIMIENTO
			TIPO_MOVIMIENTO,YEAR_EXPEDIENTE,REF_EXPEDIENTE,COD_ENTIDAD_COLABORADORA,F_ALTERACION_CATASTRAL)
	values (
			xDelegacionMEH,xGerencia,xAyto,SubStr(vRegFinca,3,14),SubStr(vRegFinca,17,4),
			--DATOS FISICOS
			vLONG_FACHADA,SubStr(vRegFinca,64,2),vSUPERFICIE_SUELO,vFONDO_SUELO,
			--DATOS DE VALORACION
			SubStr(vRegFinca,76,5),SubStr(vRegFinca,81,3),SubStr(vRegFinca,84,1),SubStr(vRegFinca,85,1),SubStr(vRegFinca,86,1),
			SubStr(vRegFinca,87,1),SubStr(vRegFinca,88,1),SubStr(vRegFinca,89,1),SubStr(vRegFinca,90,1),SubStr(vRegFinca,91,1),
			SubStr(vRegFinca,92,1),SubStr(vRegFinca,93,1),SubStr(vRegFinca,94,3),SubStr(vRegFinca,97,1),
			SubStr(vRegFinca,99,3),SubStr(vRegFinca,102,1),SubStr(vRegFinca,103,1),SubStr(vRegFinca,104,1),SubStr(vRegFinca,105,1),
			SubStr(vRegFinca,106,1),SubStr(vRegFinca,107,1),SubStr(vRegFinca,108,1),SubStr(vRegFinca,109,1),
			--DATOS DEL MOVIMIENTO
			SubStr(vRegFinca,535,1),SubStr(vRegFinca,536,4),SubStr(vRegFinca,540,13),SubStr(vRegFinca,553,3),vF_ALTERACION_CATASTRAL
	);
	
	
end;
	


PROCEDURE Inserta_Reg_Unidad_Construc(xDelegacionMEH in char, xGerencia in char, xAyto in char,vRegFinca in varchar2)
as
	vF_ALTERACION_CATASTRAL	date;
	vLONG_FACHADA			FLOAT;
begin


	if TRIM(SubStr(vRegFinca,149,5)) is null then
		vLONG_FACHADA:=0;
	else
		vLONG_FACHADA:=TO_NUMBER(TRIM(SubStr(vRegFinca,149,5)));
	end if;

	
	
	IF SubStr(vRegFinca,556,8)='00000000' or TRIM(SubStr(vRegFinca,556,8)) is null THEN
		vF_ALTERACION_CATASTRAL:=NULL;
	ELSE 
		vF_ALTERACION_CATASTRAL:=TO_DATE(SubStr(vRegFinca,556,8),'YYYYMMDD');
	END IF;

	insert into IBI_CONSTRUCTIVA_FURB (DELEGACION_MEH,GERENCIA,MUNICIPIO,REF_CATASTRAL,COD_UNIDAD_CONSTRUCTIVA,
			--DOMICILIO TRIBUTARIO DE LA UNIDAD CONSTRUCTIVA
			COD_ENTIDAD_MENOR,COD_VIA_PUBLICA,TIPO_VIA,NOMBRE_VIA,PRIMER_NUMERO,PRIMERA_LETRA,SEGUNDO_NUMERO,SEGUNDA_LETRA,KILOMETRO,
			BLOQUE,TEXTO_DIRECCION,CODIGO_POSTAL,
			--DATOS FISICOS
			YEAR_CONSTRUCCION,LONG_FACHADA,USO_AGRARIO_LOCALES_ASOC,
			--DATOS DE VALORACION
			COD_VA_PUBLICA_PONENCIA,COD_TRAMO_VIA,NUM_FACHADAS,APLICA_COEF_LONG_FACHADA,COD_COEF_ESTADO_CONSERVA,
			APLICA_COEF_DEPRECIACION,COEF_CORRECTOR,APLICA_COEF_SITU_ESPECIAL,APLICA_COEF_USO_NO_LUCRATIVO,	
			AGUA,ELECTRICIDAD,ALUMBRADO,DESMONTE,PAVIMENTACION,ALCANTARILLADO,EXACTITUD_YEAR_CONSTRUCCION,
			--DATOS DEL MOVIMIENTO
			TIPO_MOVIMIENTO,YEAR_EXPEDIENTE,REF_EXPEDIENTE,COD_ENTIDAD_COLABORADORA,F_ALTERACION_CATASTRAL)
	values (xDelegacionMEH,xGerencia,xAyto,SubStr(vRegFinca,3,14),SubStr(vRegFinca,17,4),
			SubStr(vRegFinca,59,2),SubStr(vRegFinca,61,5),SubStr(vRegFinca,66,5),SubStr(vRegFinca,71,25),SubStr(vRegFinca,96,4),
			SubStr(vRegFinca,100,1),SubStr(vRegFinca,101,4),SubStr(vRegFinca,105,1),SubStr(vRegFinca,106,5),SubStr(vRegFinca,111,4),
			SubStr(vRegFinca,115,25),SubStr(vRegFinca,140,5),
			--DATOS FISICOS
			SubStr(vRegFinca,145,4),vLONG_FACHADA,SubStr(vRegFinca,154,1),
			--DATOS DE VALORACION
			SubStr(vRegFinca,155,5),SubStr(vRegFinca,160,3),SubStr(vRegFinca,163,1),SubStr(vRegFinca,164,1),SubStr(vRegFinca,165,1),
			SubStr(vRegFinca,166,1),SubStr(vRegFinca,167,3),SubStr(vRegFinca,170,1),SubStr(vRegFinca,171,1),SubStr(vRegFinca,172,1),
			SubStr(vRegFinca,173,1),SubStr(vRegFinca,174,1),SubStr(vRegFinca,175,1),SubStr(vRegFinca,176,1),SubStr(vRegFinca,177,1),
			SubStr(vRegFinca,178,1),
			--DATOS DEL MOVIMIENTO
			SubStr(vRegFinca,535,1),SubStr(vRegFinca,536,4),SubStr(vRegFinca,540,13),SubStr(vRegFinca,553,3),vF_ALTERACION_CATASTRAL
	);
	
end;
	


PROCEDURE Inserta_Reg_Construccion(xDelegacionMEH in char, xGerencia in char, xAyto in char,vRegFinca in varchar2,xPrincipal in varchar2)
AS
	vF_ALTERACION_CATASTRAL	DATE;
	vSuperTotalLocal		FLOAT;
	vSuperPorches			FLOAT;
	vSuperOtrasPlantas		FLOAT;
BEGIN


	if TRIM(SubStr(vRegFinca,80,7)) is null then
		vSuperTotalLocal:=0;
	else
		vSuperTotalLocal:=TO_NUMBER(TRIM(SubStr(vRegFinca,80,7)));
	end if;
	
	if TRIM(SubStr(vRegFinca,87,7)) is null then
		vSuperPorches:=0;
	else
		vSuperPorches:=TO_NUMBER(TRIM(SubStr(vRegFinca,87,7)));
	end if;
	
	if TRIM(SubStr(vRegFinca,94,7)) is null then
		vSuperOtrasPlantas:=0;
	else
		vSuperOtrasPlantas:=TO_NUMBER(TRIM(SubStr(vRegFinca,94,7)));
	end if;

	IF SubStr(vRegFinca,556,8)='00000000' or TRIM(SubStr(vRegFinca,556,8)) is null THEN
		vF_ALTERACION_CATASTRAL:=NULL;
	ELSE 
		vF_ALTERACION_CATASTRAL:=TO_DATE(SubStr(vRegFinca,556,8),'YYYYMMDD');
	END IF;


	INSERT INTO IBI_CONSTRUCCION_FURB(DELEGACION_MEH,GERENCIA,MUNICIPIO,REF_CATASTRAL,NUM_ORDEN_CONSTRUCCION,NUM_CARGO,COD_UNIDAD_CONSTRUCTIVA,
			--DOMICILIO TRIBUTARIO DEL ELEMENTO
			BLOQUE,ESCALERA,PLANTA,PUERTA,
			--DATOS FISICOS
			COD_DESTINO,TIPO_REFORMA,YEAR_REFORMA,LOCAL_INTERIOR,SUPERFICIE_TOTAL_LOCAL,SUPERFICIE_PORCHES_TERR,SUPERFICIE_LOCAL_OTRAS_PL,	
			--DATOS DE VALORACION
			TIPOLOGIA_CONSTRUCTIVA,COD_USO,COD_CATEGORIA,COD_MODALIDAD_REPARTO,COD_TIPO_VALOR_APLICAR,	
			COEF_CORRECTOR,APLICA_COEFICIENTE,
			--DATOS DEL MOVIMIENTO
			TIPO_MOVIMIENTO,YEAR_EXPEDIENTE,REF_EXPEDIENTE,COD_ENTIDAD_COLABORADORA,F_ALTERACION_CATASTRAL,PRINCIPAL)
	VALUES (xDelegacionMEH,xGerencia,xAyto,SubStr(vRegFinca,3,14),SubStr(vRegFinca,17,4),SubStr(vRegFinca,21,4),SubStr(vRegFinca,25,4),
			--DOMICILIO TRIBUTARIO DEL ELEMENTO
			SubStr(vRegFinca,59,4),SubStr(vRegFinca,63,2),SubStr(vRegFinca,65,3),SubStr(vRegFinca,68,3),
			--DATOS FISICOS
			SubStr(vRegFinca,71,3),SubStr(vRegFinca,74,1),SubStr(vRegFinca,75,4),SubStr(vRegFinca,79,1),vSuperTotalLocal,
			vSuperPorches,vSuperOtrasPlantas,
			--DATOS DE VALORACION
			SubStr(vRegFinca,101,5),SubStr(vRegFinca,106,1),SubStr(vRegFinca,107,1),SubStr(vRegFinca,108,3),SubStr(vRegFinca,111,1),
			SubStr(vRegFinca,112,3),SubStr(vRegFinca,115,1),
			--DATOS DEL MOVIMIENTO
			SubStr(vRegFinca,535,1),SubStr(vRegFinca,536,4),SubStr(vRegFinca,540,13),SubStr(vRegFinca,553,3),vF_ALTERACION_CATASTRAL,xPRINCIPAL
	);

END;



PROCEDURE Inserta_Reg_Unidad_Cargo(xDelegacionMEH in char, xGerencia in char, xAyto in char,vRegFinca in varchar2)
AS
	vF_ALTERACION_CATASTRAL	date;
	vVALOR_CATASTRAL float;
	vVALOR_SUELO float;
	vVALOR_CONSTRUCCION	float;
	vBASE_LIQUIDABLE float;
	
	vSUPERF_ELEM_CONSTRUCTIVOS float;
	vSUPERFICIE_ELEM_SUELO float;
BEGIN


	if TRIM(SubStr(vRegFinca,433,12)) is null then
		vVALOR_CATASTRAL:=0;
	else
		vVALOR_CATASTRAL:=TO_NUMBER(SubStr(vRegFinca,433,12))/100;
	end if;

	if TRIM(SubStr(vRegFinca,445,12)) is null then
		vVALOR_SUELO:=0;
	else
		vVALOR_SUELO:=TO_NUMBER(SubStr(vRegFinca,445,12))/100;
	end if;
	
	if TRIM(SubStr(vRegFinca,457,12)) is null then
		vVALOR_CONSTRUCCION:=0;
	else
		vVALOR_CONSTRUCCION:=TO_NUMBER(SubStr(vRegFinca,457,12))/100;
	end if;
	
	if TRIM(SubStr(vRegFinca,469,12)) is null then
		vBASE_LIQUIDABLE:=0;
	else
		vBASE_LIQUIDABLE:=TO_NUMBER(SubStr(vRegFinca,469,12))/100;
	end if;
	
	if TRIM(SubStr(vRegFinca,496,7)) is null then
		vSUPERF_ELEM_CONSTRUCTIVOS:=0;
	else
		vSUPERF_ELEM_CONSTRUCTIVOS:=TO_NUMBER(SubStr(vRegFinca,496,7));
	end if;
	
	if TRIM(SubStr(vRegFinca,503,7)) is null then
		vSUPERFICIE_ELEM_SUELO:=0;
	else
		vSUPERFICIE_ELEM_SUELO:=TO_NUMBER(SubStr(vRegFinca,503,7));
	end if;
	



	IF SubStr(vRegFinca,560,8)='00000000' or TRIM(SubStr(vRegFinca,560,8)) is null THEN
		vF_ALTERACION_CATASTRAL:=NULL;
	ELSE 
		vF_ALTERACION_CATASTRAL:=TO_DATE(SubStr(vRegFinca,560,8),'YYYYMMDD');
	END IF;


	INSERT INTO IBI_CARGO_FURB(DELEGACION_MEH,GERENCIA,MUNICIPIO,REF_CATASTRAL,NUM_CARGO,PRIMER_CARACTER_CONTROL,SEGUN_CARACTER_CONTROL, 
			NUM_FIJO,CARACTER_CONTROL_N_FIJO,COEF_PARTICIPACION,DISTRITO_CENSAL,
			--DOMICILIO TRIBUTARIO DEL ELEMENTO
			COD_ENTIDAD_MENOR,COD_VIA_PUBLICA,TIPO_VIA,NOMBRE_VIA,PRIMER_NUMERO,PRIMERA_LETRA,SEGUNDO_NUMERO,SEGUNDA_LETRA,KILOMETRO,
			BLOQUE,TEXTO_DIRECCION,CODIGO_POSTAL,ESCALERA,PLANTA,PUERTA,
			--IDENTIFICACION DEL TITULAR
			NIF,PERSONALIDAD,NOMBRE,NUM_COMPONENTES,COMPLEMENTO_NOMBRE,
			--DOMICILIO FISCAL DEL TITULAR
			COD_DEL_MEH,COD_MUNICIPIO_DGC,COD_PROVI_INE_FISCAL,COD_MUNI_INE_FISCAL,COD_VIA_PUBLICA_FISCAL,
			TIPO_VIA_FISCAL,NOMBRE_VIA_FISCAL,PRIMER_NUMERO_FISCAL,PRIMERA_LETRA_FISCAL,SEGUNDO_NUMERO_FISCAL,SEGUNDA_LETRA_FISCAL,
			KILOMETRO_FISCAL,BLOQUE_FISCAL,TEXTO_DIRECCION_FISCAL,ESCALERA_FISCAL,PLANTA_FISCAL,PUERTA_FISCAL,COD_POSTAL_FISCAL,
			APARTADO_CORREOS,PAIS,PROVINCIA,MUNICIPIO_FISCAL,
			--DATOS ECONOMICOS VALORATIVOS DEL INMUEBLE
			YEAR_VALOR_CATASTRAL,VALOR_CATASTRAL,VALOR_SUELO,VALOR_CONSTRUCCION,BASE_LIQUIDABLE,CLAVE_USO,YEAR_ULTIMA_REVISION,
			YEAR_ULTIMA_NOTIFICACION,NUM_ULTIMA_NOTI,SUPERF_ELEM_CONSTRUCTIVOS,SUPERFICIE_ELEM_SUELO,COEFICIENTE_FINCA,APLICA_PRECIO_MAX_ADMIN,
			YEAR_FIN_PRECIO_MAX_ADMIN,TIPO_PROPIEDAD_CARGO,
			--DATOS DEL MOVIMIENTO
			TIPO_MOVIMIENTO,YEAR_EXPEDIENTE,REF_EXPEDIENTE,EJERCICIO_ENTRADA_PADRON,COD_ENTIDAD_COLABORADORA,F_ALTERACION_CATASTRAL)
	VALUES(xDelegacionMEH,xGerencia,xAyto,SubStr(vRegFinca,3,14),SubStr(vRegFinca,17,4),SubStr(vRegFinca,21,1),SubStr(vRegFinca,22,1),
			SubStr(vRegFinca,23,8),SubStr(vRegFinca,31,1),SubStr(vRegFinca,32,5),SubStr(vRegFinca,57,2),
			--DOMICILIO TRIBUTARIO DEL ELEMENTO
			SubStr(vRegFinca,59,2),SubStr(vRegFinca,61,5),SubStr(vRegFinca,66,5),SubStr(vRegFinca,71,25),SubStr(vRegFinca,96,4),
			SubStr(vRegFinca,100,1),SubStr(vRegFinca,101,4),SubStr(vRegFinca,105,1),SubStr(vRegFinca,106,5),SubStr(vRegFinca,111,4),
			SubStr(vRegFinca,115,25),SubStr(vRegFinca,140,5),SubStr(vRegFinca,145,2),SubStr(vRegFinca,147,3),SubStr(vRegFinca,150,3),
			--IDENTIFICACION DEL TITULAR
			SubStr(vRegFinca,153,9),SubStr(vRegFinca,162,1),SubStr(vRegFinca,163,60),SubStr(vRegFinca,223,4),SubStr(vRegFinca,227,20),
			--DOMICILIO FISCAL DEL TITULAR
			SubStr(vRegFinca,247,2),SubStr(vRegFinca,249,3),SubStr(vRegFinca,252,2),SubStr(vRegFinca,254,3),SubStr(vRegFinca,257,5),
			SubStr(vRegFinca,262,5),SubStr(vRegFinca,267,25),SubStr(vRegFinca,292,4),SubStr(vRegFinca,296,1),SubStr(vRegFinca,297,4),
			SubStr(vRegFinca,301,1),SubStr(vRegFinca,302,5),SubStr(vRegFinca,307,4),SubStr(vRegFinca,311,25),SubStr(vRegFinca,336,2),
			SubStr(vRegFinca,338,3),SubStr(vRegFinca,341,3),SubStr(vRegFinca,344,5),SubStr(vRegFinca,349,5),SubStr(vRegFinca,354,25),
			SubStr(vRegFinca,379,25),SubStr(vRegFinca,404,25),
			--DATOS ECONOMICOS VALORATIVOS DEL INMUEBLE
			SubStr(vRegFinca,429,4),vVALOR_CATASTRAL,vVALOR_SUELO,vVALOR_CONSTRUCCION,vBASE_LIQUIDABLE,
			SubStr(vRegFinca,481,1),SubStr(vRegFinca,482,4),SubStr(vRegFinca,486,4),SubStr(vRegFinca,490,6),vSUPERF_ELEM_CONSTRUCTIVOS,
			vSUPERFICIE_ELEM_SUELO,SubStr(vRegFinca,510,7),SubStr(vRegFinca,517,1),SubStr(vRegFinca,518,4),SubStr(vRegFinca,522,1),
			--DATOS DEL MOVIMIENTO
			SubStr(vRegFinca,535,1),SubStr(vRegFinca,536,4),SubStr(vRegFinca,540,13),SubStr(vRegFinca,553,4),SubStr(vRegFinca,557,3),
			vF_ALTERACION_CATASTRAL
	);


END;


PROCEDURE Inserta_Reparto_Elementos(xDelegacionMEH in char, xGerencia in char, xAyto in char,vRegFinca in varchar2)
AS
	vF_ALTERACION_CATASTRAL	date;
	vSigue 	boolean default True;
	i 		integer;
	xID 	integer;
BEGIN


	IF SubStr(vRegFinca,556,8)='00000000' or TRIM(SubStr(vRegFinca,556,8)) is null THEN
		vF_ALTERACION_CATASTRAL:=NULL;
	ELSE 
		vF_ALTERACION_CATASTRAL:=TO_DATE(SubStr(vRegFinca,556,8),'YYYYMMDD');
	END IF;

	INSERT INTO IBI_REPARTO_CONSTRUCCION_FURB(DELEGACION_MEH,GERENCIA,MUNICIPIO,REF_CATASTRAL,NUM_ORDEN_REGISTRO,NUM_ORDEN_CONSTRUCCION,
			--DATOS DEL MOVIMIENTO
			TIPO_MOVIMIENTO,YEAR_EXPEDIENTE,REF_EXPEDIENTE,COD_ENTIDAD_COLABORADORA,F_ALTERACION_CATASTRAL)
	VALUES (xDelegacionMEH,xGerencia,xAyto,SubStr(vRegFinca,3,14),SubStr(vRegFinca,17,4),SubStr(vRegFinca,21,4),
			--DATOS DEL MOVIMIENTO
			SubStr(vRegFinca,535,1),SubStr(vRegFinca,536,4),SubStr(vRegFinca,540,13),SubStr(vRegFinca,553,3),vF_ALTERACION_CATASTRAL)
	returning ID into xID;

			
	--la primera vez se empieza en la posicion 59			
	i:=59;
	WHILE vSigue LOOP
	
		if i >= 509 then
			vSigue:=False;
			return;
		end if;
		
		
		if SubStr(vRegFinca,i,10)<>'0000000000' then
		
			insert into FURB_DESGLOSE_REPARTO(Municipio,ID_REPARTO,LOCALES_PROPIEDAD_COMPARTIDA,PORCEN_REPARTO)
			values (xAyto,xID,SubStr(vRegFinca,i,4),SubStr(vRegFinca,i+4,6));
			
		end if;
		
		i:=i+10;
		
	end loop;
			
END;

	
/****************************************************************************************************
AUTOR: Agustín Léon Robles 31/06/2004 
FUNCION: Lee desde oracle cada campo en el fichero FINURB y lo inserta en la tabla correspondiente en funcion del codigo
PARAMETROS: 	xAYTO: Codigo de Ayto 		
				xFILENAME: Nombre del fichero 
				xPATH: Localizacion fisica de dicho fichero 
*****************************************************************************************************/
PROCEDURE IBI_FINURB_READ (
	xAyto				IN  VARCHAR2,
	xFileName			IN	VARCHAR2,
	xPath				IN	VARCHAR2,
	xNumReg				OUT	INTEGER,
	xError				OUT	VARCHAR2) 
AS
	vOutFile 	   			UTL_FILE.FILE_TYPE;
	vRegFinca	   			VARCHAR2(720);
	xDelegacionMEH			char(2);
	xGerencia				char(1);

	PROCEDURE recNgo (str IN VARCHAR2, xError OUT VARCHAR2)
	IS
	BEGIN
		xError:= 'UTL_FILE error '||str;
		UTL_FILE.FCLOSE (vOutFile);
	END;

begin
	

	xError:= null;
	vOutFile:=UTL_FILE.FOPEN(rtrim(xPath),rtrim(xFileName),'R');
	xNumReg:= 0;
	
	UTL_FILE.GET_LINE(vOutFile,vRegFinca); --para saltar la línea de cabecera 
	xDelegacionMEH:=SUBSTR(vRegFinca,3,2);
	xGerencia:=SUBSTR(vRegFinca,5,1);
	
	delete from FURB_DESGLOSE_REPARTO where DELEGACION_MEH=xDelegacionMEH AND Gerencia=xGerencia and Municipio=xAyto; 
	delete from IBI_REPARTO_CONSTRUCCION_FURB where DELEGACION_MEH=xDelegacionMEH AND Gerencia=xGerencia and Municipio=xAyto; 
	delete from IBI_CARGO_FURB where DELEGACION_MEH=xDelegacionMEH AND Gerencia=xGerencia and Municipio=xAyto; 
	delete from IBI_CONSTRUCCION_FURB where DELEGACION_MEH=xDelegacionMEH AND Gerencia=xGerencia and Municipio=xAyto;
	delete from IBI_CONSTRUCTIVA_FURB where DELEGACION_MEH=xDelegacionMEH AND Gerencia=xGerencia and Municipio=xAyto;
	delete from IBI_SUELO_FURB where DELEGACION_MEH=xDelegacionMEH AND Gerencia=xGerencia and Municipio=xAyto;
	delete from IBI_FINCA_FURB where DELEGACION_MEH=xDelegacionMEH AND Gerencia=xGerencia and Municipio=xAyto;

	
	--para el primer registro de tipo 21
	UTL_FILE.GET_LINE(vOutFile,vRegFinca);
	LOOP
	BEGIN
	
		--Inserta registro de Finca		
		IF SUBSTR(vRegFinca,1,2)='21' THEN
			Inserta_Reg_Finca(xDelegacionMEH,xGerencia,xAyto,vRegFinca);
				
			xNumReg:=xNumReg+1;
			UTL_FILE.GET_LINE(vOutFile,vRegFinca);
		END IF;	
		
		--Insertar registro de Suelo (subparcelacion)
		
		IF SUBSTR(vRegFinca,1,2)='22' THEN
			Inserta_Reg_Suelo(xDelegacionMEH,xGerencia,xAyto,vRegFinca);
			xNumReg:=xNumReg+1;
			UTL_FILE.GET_LINE(vOutFile,vRegFinca);
		END IF;	
		
		--Leemos el siguiente registro para saber si es de Tipo 23, 24 o 25		
		IF SUBSTR(vRegFinca,1,2)='23' THEN
			
			--Insertamos el registro de unidad constructiva y leemos para el siguiente registro
			Inserta_Reg_Unidad_Construc(xDelegacionMEH,xGerencia,xAyto,vRegFinca);
			UTL_FILE.GET_LINE(vOutFile,vRegFinca);
		end if;
		
		IF SUBSTR(vRegFinca,1,2)='24' THEN
		
			--Insertamos el registro de construccion y leemos para el siguiente registro
			Inserta_Reg_Construccion(xDelegacionMEH,xGerencia,xAyto,vRegFinca,'N');			
			UTL_FILE.GET_LINE(vOutFile,vRegFinca);
		end if;
		
		IF SUBSTR(vRegFinca,1,2)='25' THEN
		
			--Insertamos el registro de Cargo o Unidad Fiscal
			Inserta_Reg_Unidad_Cargo(xDelegacionMEH,xGerencia,xAyto,vRegFinca);
			UTL_FILE.GET_LINE(vOutFile,vRegFinca);
		end if;
		
		IF SUBSTR(vRegFinca,1,2)='26' THEN
			--Insertamos el registro de Reparto de elementos de construcción comunes entre cargos
			UTL_FILE.GET_LINE(vOutFile,vRegFinca);
		end if;
		
		IF SUBSTR(vRegFinca,1,2)='27' THEN
			--Insertamos el registro de Reparto de elementos de construcción comunes entre elementos normales
			Inserta_Reparto_Elementos(xDelegacionMEH,xGerencia,xAyto,vRegFinca);
			UTL_FILE.GET_LINE(vOutFile,vRegFinca);
		end if;
		
		IF SUBSTR(vRegFinca,1,2)='90' THEN
			exit;
		end if;
		
	END;
	END LOOP;
	
	UTL_FILE.FCLOSE(vOutFile);

	EXCEPTION
		WHEN NO_DATA_FOUND 					THEN recNgo ('no_data_found',xError);
	    WHEN UTL_FILE.INVALID_PATH 			THEN recNgo ('invalid_path',xError);
	    WHEN UTL_FILE.INVALID_MODE 			THEN recNgo ('invalid_mode',xError);
	    WHEN UTL_FILE.INVALID_FILEHANDLE 	THEN recNgo ('invalid_filehandle',xError);
	    WHEN UTL_FILE.INVALID_OPERATION 	THEN recNgo ('invalid_operation',xError);
	    WHEN UTL_FILE.READ_ERROR 			THEN recNgo ('read_error',xError);
	    WHEN UTL_FILE.WRITE_ERROR 			THEN recNgo ('write_error',xError);
	    WHEN UTL_FILE.INTERNAL_ERROR 		THEN recNgo ('internal_error',xError);
		WHEN VALUE_ERROR 					THEN recNgo ('value_error',xError); 
		WHEN OTHERS 						THEN recNgo (To_CHAR(SQLCODE)||SQLERRM,xError); 

END;




END PkFinUrb;
/
