
--
-- cambios a realizar para poder añadir el campo ID en HIS_CARGOREAL_IBI como primary key
-- y copiar los datos a una tabla temporal para despues borrar la tabla y volver a pasarle
-- los datos
--


CREATE TABLE HIS_CARGOREAL_IBI_TMP(
	IDIBI				INTEGER NOT NULL,
	AYTO				CHAR(3) NOT NULL,
	FECHA				DATE DEFAULT SYSDATE,
	USUARIO			CHAR(30) DEFAULT USER,
	TIPO_VARIACION		CHAR(1) CHECK (TIPO_VARIACION IN ('A','M')),
	QUIEN_VARIA			CHAR(1) CHECK (QUIEN_VARIA IN ('P','M','R','I')),
	ULTIMA_VARIACION		CHAR(1) DEFAULT 'N' CHECK (ULTIMA_VARIACION IN ('S','N')),
	NIF				CHAR(10),
    NOMBRE			CHAR(60),
	TIPO_VIA_FISCAL		CHAR(5),
	NOMBRE_VIA_FISCAL		CHAR(25),
	PRIMER_NUMERO_FISCAL	CHAR(4),
	ESCALERA_FISCAL		CHAR(2),
	PLANTA_FISCAL		CHAR(3),
	PUERTA_FISCAL		CHAR(3),
	COD_POSTAL_FISCAL		CHAR(5),
	MUNICIPIO_FISCAL		CHAR(25),
	PROVINCIA			CHAR(25),
	PAIS				CHAR(25),
	TIPO_VIA			CHAR(5),
	NOMBRE_VIA			CHAR(25),
	PRIMER_NUMERO		CHAR(4),
	BLOQUE			CHAR(4),
	ESCALERA			CHAR(2),
	PLANTA			CHAR(3),
	PUERTA			CHAR(3)
)TABLESPACE GT;


INSERT INTO HIS_CARGOREAL_IBI_TMP SELECT IDIBI,
	AYTO,
	FECHA,
	USUARIO,
	TIPO_VARIACION,
	QUIEN_VARIA,
	ULTIMA_VARIACION,
	NIF,
  NOMBRE,
	TIPO_VIA_FISCAL,
	NOMBRE_VIA_FISCAL,
	PRIMER_NUMERO_FISCAL,
	ESCALERA_FISCAL,
	PLANTA_FISCAL,
	PUERTA_FISCAL,
	COD_POSTAL_FISCAL,
	MUNICIPIO_FISCAL,
	PROVINCIA,
	PAIS,
	TIPO_VIA,
	NOMBRE_VIA,
	PRIMER_NUMERO,
	BLOQUE,
	ESCALERA,
	PLANTA,
	PUERTA FROM HIS_CARGOREAL_IBI;

DROP TABLE HIS_CARGOREAL_IBI;

CREATE TABLE HIS_CARGOREAL_IBI;

CREATE OR REPLACE TRIGGER T_INS_HIS_CARGOREAL_IBI
BEFORE INSERT ON HIS_CARGOREAL_IBI
FOR EACH ROW
BEGIN

	SELECT GENCARGOREAL_IBI.NEXTVAL INTO :NEW.ID FROM DUAL;

END;
/

INSERT INTO HIS_CARGOREAL_IBI (IDIBI,
	AYTO,
	FECHA,
	USUARIO,
	TIPO_VARIACION,
	QUIEN_VARIA,
	ULTIMA_VARIACION,
	NIF,
  NOMBRE,
	TIPO_VIA_FISCAL,
	NOMBRE_VIA_FISCAL,
	PRIMER_NUMERO_FISCAL,
	ESCALERA_FISCAL,
	PLANTA_FISCAL,
	PUERTA_FISCAL,
	COD_POSTAL_FISCAL,
	MUNICIPIO_FISCAL,
	PROVINCIA,
	PAIS,
	TIPO_VIA,
	NOMBRE_VIA,
	PRIMER_NUMERO,
	BLOQUE,
	ESCALERA,
	PLANTA,
	PUERTA) SELECT IDIBI,
	AYTO,
	FECHA,
	USUARIO,
	TIPO_VARIACION,
	QUIEN_VARIA,
	ULTIMA_VARIACION,
	NIF,
  NOMBRE,
	TIPO_VIA_FISCAL,
	NOMBRE_VIA_FISCAL,
	PRIMER_NUMERO_FISCAL,
	ESCALERA_FISCAL,
	PLANTA_FISCAL,
	PUERTA_FISCAL,
	COD_POSTAL_FISCAL,
	MUNICIPIO_FISCAL,
	PROVINCIA,
	PAIS,
	TIPO_VIA,
	NOMBRE_VIA,
	PRIMER_NUMERO,
	BLOQUE,
	ESCALERA,
	PLANTA,
	PUERTA FROM HIS_CARGOREAL_IBI_TMP;

